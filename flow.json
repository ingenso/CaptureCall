[{"id":"60528a1b.f32364","type":"tab","label":"Startup","disabled":false,"info":""},{"id":"e3cbac21.52804","type":"tab","label":"Receive Page & Add to DB","disabled":false,"info":""},{"id":"23c43518.b3ff0a","type":"tab","label":"Pager Dynamic Display","disabled":false,"info":""},{"id":"1c96dbb1.1bc354","type":"tab","label":"Log Display Full","disabled":false,"info":""},{"id":"b209c94d.26d798","type":"tab","label":"Log Display Daily","disabled":false,"info":""},{"id":"b00e2d77.a9931","type":"tab","label":"Export","disabled":false,"info":""},{"id":"ba76d305.cf8ad","type":"tab","label":"DB Utilities","disabled":false,"info":""},{"id":"36884d4.675edb2","type":"tab","label":"Testing","disabled":true,"info":""},{"id":"ad17a71d.1e1ea8","type":"tab","label":"Smart Repeater","disabled":false,"info":""},{"id":"85d51a2d.db2228","type":"subflow","name":"Receive Page SDR","info":"","category":"input","in":[],"out":[{"x":1720,"y":60,"wires":[{"id":"4437d3de.ca8fdc","port":0}]}]},{"id":"76a9f5f0.1cf2dc","type":"subflow","name":"Receive Page LRS","info":"","category":"input","in":[],"out":[{"x":1160,"y":120,"wires":[{"id":"6862b344.2783ac","port":0}]}]},{"id":"3b51b3fa.8136dc","type":"subflow","name":"Receive Page TRX1","info":"","category":"input","in":[],"out":[{"x":880,"y":100,"wires":[{"id":"7e312125.1eb7b","port":0}]}]},{"id":"8ad92631.0da208","type":"websocket-listener","z":"","path":"/log-full/send","wholemsg":"true"},{"id":"c0402614.f01608","type":"websocket-listener","z":"","path":"/log-daily/receive","wholemsg":"true"},{"id":"aae6ab09.c69b28","type":"serial-port","z":"","serialport":"/dev/ttyUSB0","serialbaud":"9600","databits":"8","parity":"none","stopbits":"1","newline":"50","bin":"false","out":"interbyte","addchar":false,"responsetimeout":""},{"id":"32989c5a.d6ee14","type":"websocket-listener","z":"","path":"/log-full/receive","wholemsg":"true"},{"id":"fd38eee5.8bd8a","type":"sqlitedb","z":"","db":"/home/ingenso/CaptureCall.db","mode":"RWC"},{"id":"e1c85b2c.abed18","type":"json-db-collection","z":"","name":"","collection":"settings","save":true},{"id":"7016657f.45b3ec","type":"websocket-listener","z":"","path":"/ws/export","wholemsg":"false"},{"id":"ff68c365.94b25","type":"websocket-listener","z":"","path":"/ws/sender","wholemsg":"false"},{"id":"d9d1357a.d4f118","type":"websocket-listener","z":"","path":"/display/receive","wholemsg":"true"},{"id":"95962f80.19ef3","type":"websocket-listener","z":"","path":"/display/send","wholemsg":"false"},{"id":"c7526c07.3fd51","type":"websocket-listener","z":"","path":"/log-daily/send","wholemsg":"true"},{"id":"66911507.b23eac","type":"websocket-listener","z":"","path":"/settings/send","wholemsg":"true"},{"id":"70e142c2.27546c","type":"websocket-listener","z":"","path":"/settings/receive","wholemsg":"true"},{"id":"c78d8a51.8b8ed8","type":"websocket-listener","z":"","path":"/export/send","wholemsg":"true"},{"id":"b7dfd67b.7d7948","type":"websocket-listener","z":"","path":"/export/receive","wholemsg":"true"},{"id":"18f900b5.35f87f","type":"websocket-listener","z":"","path":"/export/alert","wholemsg":"true"},{"id":"fbe048ec.4af8a8","type":"websocket-listener","z":"","path":"/settings/alert","wholemsg":"false"},{"id":"b006fd22.2dc63","type":"websocket-listener","z":"","path":"/display/sound","wholemsg":"true"},{"id":"2db6df1c.cd63b","type":"serial-port","z":"","serialport":"/dev/ttyUSB1","serialbaud":"9600","databits":"8","parity":"none","stopbits":"1","newline":"\\n","bin":"false","out":"char","addchar":true,"responsetimeout":"10000"},{"id":"97f51a17.2797b8","type":"serial-port","z":"","serialport":"/dev/ttyUSB0","serialbaud":"9600","databits":"8","parity":"none","stopbits":"1","newline":"\\n","bin":"false","out":"char","addchar":true,"responsetimeout":"10000"},{"id":"6c8b92a7.84a82c","type":"e-mail","z":"b00e2d77.a9931","server":"smtp.gmail.com","port":"465","secure":true,"name":"","dname":"CaptureCall System","x":1280,"y":1160,"wires":[]},{"id":"da56f422.c45fe8","type":"csv","z":"b00e2d77.a9931","name":"","sep":",","hdrin":"","hdrout":true,"multi":"one","ret":"\\n","temp":"Index, Call Point, Message, ReceivedTime, Status, StatusTime, ExportedTime, Recipient, System ID","skip":"0","x":890,"y":1180,"wires":[["e981d4fd.f427d8","8551674f.20b3f8"]]},{"id":"3f8aac1f.7c3ae4","type":"template","z":"b00e2d77.a9931","name":"Export All","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"SELECT \n`index` AS 'Index',\n`sender` AS 'Call Point',\n`content` AS 'Message',\n`rxTime`,\n`status` AS 'Status',\n`statusTime`,\n`exported`,\n`pagerNumber` AS 'Recipient',\n`sysID` AS 'System ID'\nFROM `log`\nORDER BY  `rxTime` DESC;","output":"str","x":340,"y":1220,"wires":[["f8461b70.bd71c8"]]},{"id":"e981d4fd.f427d8","type":"change","z":"b00e2d77.a9931","name":"Setup mail content","rules":[{"t":"set","p":"attachments","pt":"msg","to":"[{\t    \"filename\": 'log.csv', \t    \"content\": $$.payload\t}]","tot":"jsonata"},{"t":"set","p":"topic","pt":"msg","to":"CaptureCall System Log","tot":"str"},{"t":"set","p":"payload","pt":"msg","to":"Attached is the requested information from your CaptureCall system.","tot":"str"},{"t":"set","p":"to","pt":"msg","to":"to","tot":"global"}],"action":"","property":"","from":"","to":"","reg":false,"x":1070,"y":1180,"wires":[["6c8b92a7.84a82c"]]},{"id":"a32b6729.85e8e8","type":"http in","z":"b00e2d77.a9931","name":"","url":"/export","method":"get","upload":false,"swaggerDoc":"","x":90,"y":80,"wires":[["cf30e34b.c1eb2"]]},{"id":"af06c87d.56a788","type":"comment","z":"b00e2d77.a9931","name":"Build Webpage","info":"","x":100,"y":40,"wires":[]},{"id":"cc70f131.afde4","type":"template","z":"b00e2d77.a9931","name":"Export New","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"SELECT\n`index` AS 'Index',\n`sender` AS 'Call Point',\n`content` AS 'Message',\n`rxTime`,\n`status` AS 'Status',\n`statusTime`,\n`exported`,\n`pagerNumber` AS 'Recipient',\n`sysID` AS 'System ID'\nFROM `log` WHERE `exported` IS NULL","output":"str","x":350,"y":1180,"wires":[["f8461b70.bd71c8"]]},{"id":"f8a9f08f.97c9b","type":"template","z":"b00e2d77.a9931","name":"","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"UPDATE `log` SET `exported`= '{{timestamp}}'","output":"str","x":680,"y":940,"wires":[["1526f69b.ff5f29"]]},{"id":"c6075542.a00c48","type":"change","z":"b00e2d77.a9931","name":"","rules":[{"t":"set","p":"to","pt":"global","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":410,"y":320,"wires":[["e2ab5e5e.760e2","c1530843.813c58"]]},{"id":"f8461b70.bd71c8","type":"sqlite","z":"b00e2d77.a9931","mydb":"fd38eee5.8bd8a","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":530,"y":1180,"wires":[["2e1d4886.bea1a8"]]},{"id":"1526f69b.ff5f29","type":"sqlite","z":"b00e2d77.a9931","mydb":"fd38eee5.8bd8a","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":830,"y":940,"wires":[[]]},{"id":"e2ab5e5e.760e2","type":"DataIn","z":"b00e2d77.a9931","collection":"e1c85b2c.abed18","name":"","update":false,"path":"/email","x":550,"y":320,"wires":[]},{"id":"a4c8442.5a53eb8","type":"switch","z":"b00e2d77.a9931","name":"","property":"payload","propertyType":"msg","rules":[{"t":"cont","v":".","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":130,"y":320,"wires":[["5845d54b.1b33dc"],["3e0d960c.df324a"]]},{"id":"5845d54b.1b33dc","type":"switch","z":"b00e2d77.a9931","name":"","property":"payload","propertyType":"msg","rules":[{"t":"jsonata_exp","v":"$length(payload) >= 5","vt":"jsonata"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":270,"y":320,"wires":[["c6075542.a00c48"],["3e0d960c.df324a"]]},{"id":"c4630aee.29afb8","type":"websocket out","z":"b00e2d77.a9931","name":"Show Alert on Bad Email","server":"18f900b5.35f87f","client":"","x":630,"y":360,"wires":[]},{"id":"3e0d960c.df324a","type":"change","z":"b00e2d77.a9931","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"Please Enter a Valid eMail Address","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":420,"y":360,"wires":[["c4630aee.29afb8"]]},{"id":"c3f8d5d0.283858","type":"change","z":"b00e2d77.a9931","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"Your eMail has been Sent","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":380,"y":820,"wires":[["ea92ebe2.658898","75f1d35f.d07dac"]]},{"id":"ea92ebe2.658898","type":"websocket out","z":"b00e2d77.a9931","name":"Send Successful","server":"18f900b5.35f87f","client":"","x":570,"y":820,"wires":[]},{"id":"463f8c6f.4fd364","type":"change","z":"b00e2d77.a9931","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"Send Failed","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":380,"y":780,"wires":[["f2a91bf9.b1d3b8","68d64bf.54ca2b4"]]},{"id":"f2a91bf9.b1d3b8","type":"websocket out","z":"b00e2d77.a9931","name":"Send Failed","server":"18f900b5.35f87f","client":"","x":550,"y":780,"wires":[]},{"id":"9f4bb9c9.b550f8","type":"status","z":"b00e2d77.a9931","name":"","scope":["6c8b92a7.84a82c"],"x":80,"y":800,"wires":[["ba578bde.7214f8"]]},{"id":"ba578bde.7214f8","type":"switch","z":"b00e2d77.a9931","name":"","property":"status.text","propertyType":"msg","rules":[{"t":"eq","v":"email.status.sendfail","vt":"str"},{"t":"eq","v":"email.status.sending","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":230,"y":800,"wires":[["463f8c6f.4fd364"],[],["c3f8d5d0.283858"]]},{"id":"3013dfe1.3ed01","type":"comment","z":"b00e2d77.a9931","name":"Catch Email Send Errors","info":"","x":130,"y":720,"wires":[]},{"id":"86082327.d62aa","type":"link in","z":"b00e2d77.a9931","name":"","links":["721569cb.074f58","8dc6af04.088a3"],"x":235,"y":1180,"wires":[["cc70f131.afde4"]]},{"id":"223b37e8.4b69d8","type":"link in","z":"b00e2d77.a9931","name":"","links":["2c82e51a.004a9a","9b0374d2.8917a8","34e0ce95.1b5ca2"],"x":235,"y":1220,"wires":[["3f8aac1f.7c3ae4"]]},{"id":"fed99ff9.b9bb1","type":"comment","z":"b00e2d77.a9931","name":"Send Email","info":"","x":90,"y":1060,"wires":[]},{"id":"a20fe9c4.7efc28","type":"link in","z":"b00e2d77.a9931","name":"","links":["43132da.14324d4","232317a3.5e58f8"],"x":35,"y":320,"wires":[["a4c8442.5a53eb8"]]},{"id":"c31b6340.5e646","type":"link in","z":"b00e2d77.a9931","name":"","links":["9cfc568.cddc1a8","11b0c0ec.55df3f"],"x":35,"y":360,"wires":[["3e0d960c.df324a"]]},{"id":"264f903e.c9e7a","type":"comment","z":"b00e2d77.a9931","name":"Set Email Address","info":"","x":110,"y":260,"wires":[]},{"id":"666f148c.df226c","type":"csv","z":"b00e2d77.a9931","name":"","sep":",","hdrin":"","hdrout":true,"multi":"one","ret":"\\n","temp":"Index, Call Point, Message, ReceivedTime, Status, StatusTime, ExportedTime, Recipient, System ID","skip":"0","x":890,"y":1140,"wires":[["4ea4678b.48f808","8551674f.20b3f8"]]},{"id":"4ea4678b.48f808","type":"change","z":"b00e2d77.a9931","name":"Setup mail content","rules":[{"t":"set","p":"attachments","pt":"msg","to":"[{\t    \"filename\": 'log.csv', \t    \"content\": $$.payload\t}]","tot":"jsonata"},{"t":"set","p":"topic","pt":"msg","to":"CaptureCall Daily Digest","tot":"str"},{"t":"set","p":"payload","pt":"msg","to":"Attached is the requested information from your CaptureCall system.","tot":"str"},{"t":"set","p":"to","pt":"msg","to":"to","tot":"global"}],"action":"","property":"","from":"","to":"","reg":false,"x":1070,"y":1140,"wires":[["6c8b92a7.84a82c"]]},{"id":"94f5535a.df3bc","type":"template","z":"b00e2d77.a9931","name":"Export New","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"SELECT\n`index` AS 'Index',\n`sender` AS 'Call Point',\n`content` AS 'Message',\n`rxTime`,\n`status` AS 'Status',\n`statusTime`,\n`exported`,\n`pagerNumber` AS 'Recipient',\n`sysID` AS 'System ID'\nFROM `log` WHERE `exported` IS NULL","output":"str","x":350,"y":1140,"wires":[["445e65fd.5881dc"]]},{"id":"445e65fd.5881dc","type":"sqlite","z":"b00e2d77.a9931","mydb":"fd38eee5.8bd8a","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":530,"y":1140,"wires":[["4df235b.7c5c0cc"]]},{"id":"f3405690.0119c8","type":"inject","z":"b00e2d77.a9931","name":"Export New Every Day","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"00 00 * * *","once":false,"onceDelay":0.1,"x":150,"y":1140,"wires":[["94f5535a.df3bc","ebaeeace.a4f718","430823b4.54fdcc"]]},{"id":"a61b2d01.623e8","type":"debug","z":"ba76d305.cf8ad","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":650,"y":120,"wires":[]},{"id":"c7008ce.9220c7","type":"sqlite","z":"ba76d305.cf8ad","mydb":"fd38eee5.8bd8a","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":490,"y":80,"wires":[["6f129008.96182"]]},{"id":"7e6e6b94.b4a724","type":"inject","z":"ba76d305.cf8ad","name":"Make Table","topic":"CREATE TABLE \"log\" ( `index` INTEGER PRIMARY KEY AUTOINCREMENT, `capcode` INTEGER, `pagerNumber` INTEGER, `sysID` INTEGER, `group` TEXT, `content` TEXT, `msgPart1` TEXT, `msgPart2` TEXT, `sender` TEXT, `rxTime` INTEGER, `status` TEXT, `statusTime` INTEGER, `exported` INTEGER, `FP` TEXT, `payload` TEXT )","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":330,"y":80,"wires":[["c7008ce.9220c7"]]},{"id":"6f129008.96182","type":"debug","z":"ba76d305.cf8ad","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":650,"y":80,"wires":[]},{"id":"ec443c0d.8626c","type":"sqlite","z":"ba76d305.cf8ad","mydb":"fd38eee5.8bd8a","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":490,"y":240,"wires":[["24bd4830.57f6e8"]]},{"id":"9d1e6dbe.d89e2","type":"inject","z":"ba76d305.cf8ad","name":"Clear Table","topic":"DELETE FROM 'log';","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":330,"y":240,"wires":[["ec443c0d.8626c"]]},{"id":"aed60ae.6b45df8","type":"sqlite","z":"ba76d305.cf8ad","mydb":"fd38eee5.8bd8a","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":490,"y":120,"wires":[["a61b2d01.623e8"]]},{"id":"c8181b2e.7db228","type":"inject","z":"ba76d305.cf8ad","name":"Select All","topic":"Select * FROM 'log';","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":340,"y":120,"wires":[["aed60ae.6b45df8"]]},{"id":"b0a6ba65.a7d928","type":"debug","z":"ba76d305.cf8ad","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":650,"y":160,"wires":[]},{"id":"8b6bd144.83a25","type":"sqlite","z":"ba76d305.cf8ad","mydb":"fd38eee5.8bd8a","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":490,"y":160,"wires":[["b0a6ba65.a7d928"]]},{"id":"df2babd6.b81898","type":"inject","z":"ba76d305.cf8ad","name":"Drop Table","topic":"DROP TABLE 'log';","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":340,"y":160,"wires":[["8b6bd144.83a25"]]},{"id":"49b647b4.b47d48","type":"comment","z":"1c96dbb1.1bc354","name":"Put All On the Webpage","info":"","x":160,"y":140,"wires":[]},{"id":"46418585.24918c","type":"http response","z":"1c96dbb1.1bc354","name":"","statusCode":"","headers":{},"x":830,"y":80,"wires":[]},{"id":"672cd54b.015afc","type":"http in","z":"1c96dbb1.1bc354","name":"","url":"/log-full","method":"get","upload":false,"swaggerDoc":"","x":130,"y":80,"wires":[["b711720e.5994a"]]},{"id":"789799aa.6b3ca8","type":"template","z":"1c96dbb1.1bc354","name":"Select Active Data","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"SELECT * FROM `log`\nORDER BY  `rxTime` DESC ","output":"str","x":210,"y":260,"wires":[["d92c7a20.a63ce8"]]},{"id":"8cf086f7.eafc98","type":"websocket out","z":"1c96dbb1.1bc354","name":"","server":"32989c5a.d6ee14","client":"","x":1090,"y":260,"wires":[]},{"id":"563aad78.25d9d4","type":"comment","z":"1c96dbb1.1bc354","name":"Build Webpage","info":"","x":140,"y":40,"wires":[]},{"id":"d92c7a20.a63ce8","type":"sqlite","z":"1c96dbb1.1bc354","mydb":"fd38eee5.8bd8a","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":390,"y":260,"wires":[["5065be0a.03bf6"]]},{"id":"45deb19d.022ce","type":"template","z":"1c96dbb1.1bc354","name":"Build Data","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"  <div class=\"nestedLog\">\n    <div class=\"bold\">Index</div>\n    <div class=\"bold\">Call Point</div>\n    <div class=\"bold\">Message</div>\n    <div class=\"bold\">Receive Time</div>\n    <div class=\"bold\">Receive Date</div>\n    <div class=\"bold\">Status</div>\n    <div class=\"bold\">Status Time</div>\n    <div class=\"bold\">Status Date</div>\n    <div class=\"bold\">Export Time</div>\n    <div class=\"bold\">Export Date</div>\n    <div class=\"bold\">Recipient</div>\n    <div class=\"bold\">System ID</div>\n    <div class=\"bold\">Group</div>\n    <div class=\"bold\">Flash Pattern</div>\n  </div>\n{{#payload}}\n  <div class=\"nestedLog {{style}}\">\n    <div>{{index}}</div>\n    <div>{{sender}}</div>\n    <div>{{{content}}}</div>\n    <div>{{displayTime}}</div>\n    <div>{{displayDate}}</div>\n    <div>{{status}}</div>\n    <div>{{displayStatusTime}}</div>\n    <div>{{displayStatusDate}}</div>\n    <div>{{{displayExportedTime}}}</div>\n    <div>{{{displayExportedDate}}}</div>\n    <div>{{pagerNumber}}</div>\n    <div>{{sysID}}</div>\n    <div>{{group}}</div>\n    <div>{{FP}}</div>\n   </div>\n{{/payload}}","output":"str","x":910,"y":260,"wires":[["8cf086f7.eafc98"]]},{"id":"575acb3d.97bd64","type":"function","z":"1c96dbb1.1bc354","name":"Convert Time to local","func":"var array = msg.payload\nvar i;\nfor (i = 0; i < array.length; i++) { \n   var rxtime = new Date(msg.payload[i].rxTime);\n                var displayDate = rxtime.toLocaleDateString();\n                var displayTime = rxtime.toLocaleTimeString();\n                \n    var statusTime = new Date(msg.payload[i].statusTime);\n                var displayStatusDate = statusTime.toLocaleDateString();\n                var displayStatusTime = statusTime.toLocaleTimeString();\n                \n  \n              \n     if (msg.payload[i].exported === null) {\n    msg.payload[i].displayExportedTime = \"n/a\"\n    msg.payload[i].displayExportedDate = \"n/a\"\n} else {\nvar exportedTime = new Date(msg.payload[i].exported);\n    var displayExportedDate = exportedTime.toLocaleDateString();\n    var displayExportedTime = exportedTime.toLocaleTimeString();\n              \n    msg.payload[i].displayExportedTime = displayExportedTime\n    msg.payload[i].displayExportedDate = displayExportedDate\n}         \n               \n                \n                msg.payload[i].displayStatusTime = displayStatusTime\n                msg.payload[i].displayStatusDate = displayStatusDate\n                \n                msg.payload[i].displayDate = displayDate\n                msg.payload[i].displayTime = displayTime\n}\n    \n \n\nreturn msg;","outputs":1,"noerr":0,"x":720,"y":260,"wires":[["45deb19d.022ce"]]},{"id":"13c2aaaa.74d295","type":"link in","z":"1c96dbb1.1bc354","name":"log","links":["363f5c70.e7e144","320906f1.fd1fba","ecbc4376.b117e","d2d8b8d2.67e9a8","8469e8af.2a6df8","2c38eaf2.df6f76","bc4b27b0.6d1478","5652483b.e30f08","e14222d1.c9cb7"],"x":75,"y":260,"wires":[["789799aa.6b3ca8"]]},{"id":"a6f41372.e1e95","type":"websocket in","z":"1c96dbb1.1bc354","name":"","server":"8ad92631.0da208","client":"","x":140,"y":200,"wires":[["dd5d2e16.22ed7"]]},{"id":"dd5d2e16.22ed7","type":"switch","z":"1c96dbb1.1bc354","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"Open","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":290,"y":200,"wires":[["789799aa.6b3ca8"]]},{"id":"4df235b.7c5c0cc","type":"function","z":"b00e2d77.a9931","name":"Convert Time to local","func":"var array = msg.payload\nvar i;\nfor (i = 0; i < array.length; i++) { \nvar rxtime = new Date(msg.payload[i].rxTime);\nvar statusTime = new Date(msg.payload[i].statusTime);\nvar exportedTime = new Date(msg.payload[i].exported);\n\nif (msg.payload[i].exported === null) {\n    msg.payload[i].ExportedTime = \"n/a\"\n} else {\nmsg.payload[i].ExportedTime = exportedTime\n}\n\nmsg.payload[i].StatusTime = statusTime\nmsg.payload[i].ReceivedTime = rxtime\n}\n    \n \n\nreturn msg;","outputs":1,"noerr":0,"x":720,"y":1140,"wires":[["666f148c.df226c"]]},{"id":"75f1d35f.d07dac","type":"change","z":"b00e2d77.a9931","name":"Time Now","rules":[{"t":"set","p":"timestamp","pt":"msg","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":540,"y":900,"wires":[["582b503f.5fb22","f8a9f08f.97c9b"]]},{"id":"2e1d4886.bea1a8","type":"function","z":"b00e2d77.a9931","name":"Convert Time to local","func":"var array = msg.payload\nvar i;\nfor (i = 0; i < array.length; i++) { \nvar rxtime = new Date(msg.payload[i].rxTime);\nvar statusTime = new Date(msg.payload[i].statusTime);\nvar exportedTime = new Date(msg.payload[i].exported);\n\nif (msg.payload[i].exported === null) {\n    msg.payload[i].ExportedTime = \"n/a\"\n} else {\nmsg.payload[i].ExportedTime = exportedTime\n}\n\nmsg.payload[i].StatusTime = statusTime\nmsg.payload[i].ReceivedTime = rxtime\n}\n    \n \n\nreturn msg;","outputs":1,"noerr":0,"x":720,"y":1180,"wires":[["da56f422.c45fe8"]]},{"id":"24bd4830.57f6e8","type":"debug","z":"ba76d305.cf8ad","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":650,"y":240,"wires":[]},{"id":"2fd5e4ed.597f5c","type":"debug","z":"ba76d305.cf8ad","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":650,"y":200,"wires":[]},{"id":"37e42e66.009442","type":"sqlite","z":"ba76d305.cf8ad","mydb":"fd38eee5.8bd8a","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":490,"y":200,"wires":[["2fd5e4ed.597f5c"]]},{"id":"d201839b.347","type":"inject","z":"ba76d305.cf8ad","name":"Reset Auto Increment (Clear Table First)","topic":"DELETE FROM sqlite_sequence WHERE name = 'log';","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":240,"y":200,"wires":[["37e42e66.009442"]]},{"id":"22c6aed.a374c52","type":"template","z":"1c96dbb1.1bc354","name":"HTML","field":"payload","fieldType":"msg","format":"html","syntax":"mustache","template":"<!DOCTYPE html>\n<html>\n<head>\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    \n    <title>{{title}}</title>\n\n    <script>\n        {{{script}}}\n    </script>\n    \n    <style>\n        {{{global.css}}}\n    </style>\n\n</head>\n\n<body onload=\"startTime()\">\n\n<div class=\"heading\">\n          \n    <div class=\"left\">{{{global.left}}}</div>\n    \n    <div class=\"middle\">\n        <h1 id=\"title\">{{title}}</h1>\n    </div>\n    \n    <div class=\"right\">\n        <div class=\"clock\" id=\"time\"></div>\n    </div>\n    \n</div>\n\n<div class=\"wrapper\" id=\"data\">\n\n</div>\n\n</body>\n\n</html>","output":"str","x":710,"y":80,"wires":[["46418585.24918c"]]},{"id":"8551674f.20b3f8","type":"debug","z":"b00e2d77.a9931","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1030,"y":1100,"wires":[]},{"id":"109cf513.333d8b","type":"comment","z":"b209c94d.26d798","name":"Put All On the Webpage","info":"","x":160,"y":140,"wires":[]},{"id":"9aac45fc.813958","type":"http in","z":"b209c94d.26d798","name":"","url":"/log-daily","method":"get","upload":false,"swaggerDoc":"","x":130,"y":80,"wires":[["fd2ae0c5.52933"]]},{"id":"8f45f53e.71ff08","type":"template","z":"b209c94d.26d798","name":"Select Active Data","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"SELECT * FROM log WHERE date(datetime(rxtime / 1000 , 'unixepoch')) = date('now') AND `sender` != \"System\"\nORDER BY  `rxTime` DESC; ","output":"str","x":210,"y":260,"wires":[["9c7288fe.0f9a98"]]},{"id":"de3ce5b7.367e28","type":"websocket out","z":"b209c94d.26d798","name":"","server":"c0402614.f01608","client":"","x":1100,"y":260,"wires":[]},{"id":"fb47baaa.cecc08","type":"comment","z":"b209c94d.26d798","name":"Build Webpage","info":"","x":140,"y":40,"wires":[]},{"id":"9c7288fe.0f9a98","type":"sqlite","z":"b209c94d.26d798","mydb":"fd38eee5.8bd8a","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":390,"y":260,"wires":[["2fd00906.8c8cb6"]]},{"id":"e6ae4362.9fe56","type":"template","z":"b209c94d.26d798","name":"Build Data","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"  <div class=\"nested10\">\n    <div class=\"bold\">Index</div>\n    <div class=\"bold\">Call Point</div>\n    <div class=\"bold\">Message</div>\n    <div class=\"bold\">Receive Time</div>\n    <div class=\"bold\">Receive Date</div>\n    <div class=\"bold\">Status</div>\n    <div class=\"bold\">Status Time</div>\n    <div class=\"bold\">Status Date</div>\n    \n    <div class=\"bold\">Recipient</div>\n    <div class=\"bold\">System ID</div>\n  </div>\n{{#payload}}\n  <div class=\"nested10 {{style}}\">\n    <div>{{index}}</div>\n    <div>{{sender}}</div>\n    <div>{{{content}}}</div>\n    <div>{{displayTime}}</div>\n    <div>{{displayDate}}</div>\n    <div>{{status}}</div>\n    <div>{{displayStatusTime}}</div>\n    <div>{{displayStatusDate}}</div>\n   \n    <div>{{pagerNumber}}</div>\n    <div>{{sysID}}</div>\n   </div>\n{{/payload}}","output":"str","x":910,"y":260,"wires":[["de3ce5b7.367e28"]]},{"id":"3945937b.26034c","type":"function","z":"b209c94d.26d798","name":"Convert Time to local","func":"var array = msg.payload\nvar i;\nfor (i = 0; i < array.length; i++) { \n   var rxtime = new Date(msg.payload[i].rxTime);\n                var displayDate = rxtime.toLocaleDateString();\n                var displayTime = rxtime.toLocaleTimeString();\n                \n    var statusTime = new Date(msg.payload[i].statusTime);\n                var displayStatusDate = statusTime.toLocaleDateString();\n                var displayStatusTime = statusTime.toLocaleTimeString();\n                \n  \n              \n     if (msg.payload[i].exported === null) {\n    msg.payload[i].displayExportedTime = \"n/a\"\n    msg.payload[i].displayExportedDate = \"n/a\"\n} else {\nvar exportedTime = new Date(msg.payload[i].exported);\n    var displayExportedDate = exportedTime.toLocaleDateString();\n    var displayExportedTime = exportedTime.toLocaleTimeString();\n              \n    msg.payload[i].displayExportedTime = displayExportedTime\n    msg.payload[i].displayExportedDate = displayExportedDate\n}         \n               \n                \n                msg.payload[i].displayStatusTime = displayStatusTime\n                msg.payload[i].displayStatusDate = displayStatusDate\n                \n                msg.payload[i].displayDate = displayDate\n                msg.payload[i].displayTime = displayTime\n}\n    \n \n\nreturn msg;","outputs":1,"noerr":0,"x":720,"y":260,"wires":[["e6ae4362.9fe56"]]},{"id":"f8b2c7bc.b77368","type":"link in","z":"b209c94d.26d798","name":"log","links":["363f5c70.e7e144","320906f1.fd1fba","ecbc4376.b117e","d2d8b8d2.67e9a8","8469e8af.2a6df8","e14222d1.c9cb7"],"x":75,"y":260,"wires":[["8f45f53e.71ff08"]]},{"id":"624fab58.d41fb4","type":"websocket in","z":"b209c94d.26d798","name":"","server":"c7526c07.3fd51","client":"","x":150,"y":200,"wires":[["8d113a2c.07c438"]]},{"id":"8d113a2c.07c438","type":"switch","z":"b209c94d.26d798","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"Open","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":310,"y":200,"wires":[["8f45f53e.71ff08"]]},{"id":"1d4b9b6.2e75565","type":"sqlite","z":"ba76d305.cf8ad","mydb":"fd38eee5.8bd8a","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":490,"y":280,"wires":[["8b82ced7.840b7"]]},{"id":"f3efd6bc.d319a8","type":"inject","z":"ba76d305.cf8ad","name":"Clear Old Records","topic":"DELETE FROM `log` WHERE `index` IN (SELECT `index` FROM `log` ORDER BY `index` DESC LIMIT -1 OFFSET 2000) AND `exported` IS NOT NULL;","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":310,"y":280,"wires":[["1d4b9b6.2e75565"]]},{"id":"8b82ced7.840b7","type":"debug","z":"ba76d305.cf8ad","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":650,"y":280,"wires":[]},{"id":"a352da15.0d4288","type":"template","z":"b00e2d77.a9931","name":"Clear Old Records","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"DELETE FROM `log` WHERE `index` IN (SELECT `index` FROM `log` ORDER BY `index` DESC LIMIT -1 OFFSET 2000) AND `exported` IS NOT NULL;","output":"str","x":510,"y":1100,"wires":[["b59b1f4c.0ec78"]]},{"id":"b59b1f4c.0ec78","type":"sqlite","z":"b00e2d77.a9931","mydb":"fd38eee5.8bd8a","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":690,"y":1100,"wires":[[]]},{"id":"ebaeeace.a4f718","type":"delay","z":"b00e2d77.a9931","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":340,"y":1100,"wires":[["a352da15.0d4288"]]},{"id":"582b503f.5fb22","type":"template","z":"b00e2d77.a9931","name":"","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO `log` (`sender`, `status`, `content`, `statusTime`, `rxTime`) VALUES ('System', 'Export Successful','Export Successful', '{{timestamp}}', '{{timestamp}}');","output":"str","x":680,"y":900,"wires":[["5c50a3a4.23c89c"]]},{"id":"5c50a3a4.23c89c","type":"sqlite","z":"b00e2d77.a9931","mydb":"fd38eee5.8bd8a","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":830,"y":900,"wires":[[]]},{"id":"ecca07b5.9ea578","type":"template","z":"b00e2d77.a9931","name":"","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO `log` (`sender`, `status`, `content`, `statusTime`, `rxTime`) VALUES ('System', 'Export Failed','Export Failed', '{{timestamp}}', '{{timestamp}}');","output":"str","x":680,"y":740,"wires":[["b09e3e3f.0fe09"]]},{"id":"b09e3e3f.0fe09","type":"sqlite","z":"b00e2d77.a9931","mydb":"fd38eee5.8bd8a","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":830,"y":740,"wires":[[]]},{"id":"33c3ae31.e41c62","type":"template","z":"b00e2d77.a9931","name":"Log Export","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO `log` (`sender`, `status`, `content`, `statusTime`, `rxTime`) VALUES ('System', 'Daily Export Triggered','Daily Export Triggered to {{global.to}}', '{{timestamp}}', '{{timestamp}}');","output":"str","x":490,"y":1060,"wires":[["e7b2f01e.3fbbf"]]},{"id":"e7b2f01e.3fbbf","type":"sqlite","z":"b00e2d77.a9931","mydb":"fd38eee5.8bd8a","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":650,"y":1060,"wires":[[]]},{"id":"68d64bf.54ca2b4","type":"change","z":"b00e2d77.a9931","name":"Time Now","rules":[{"t":"set","p":"timestamp","pt":"msg","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":540,"y":740,"wires":[["ecca07b5.9ea578"]]},{"id":"430823b4.54fdcc","type":"change","z":"b00e2d77.a9931","name":"Time Now","rules":[{"t":"set","p":"timestamp","pt":"msg","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":340,"y":1060,"wires":[["33c3ae31.e41c62"]]},{"id":"2ba16b1b.ca41c4","type":"template","z":"b00e2d77.a9931","name":"Log Export","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO `log` (`sender`, `status`, `content`, `statusTime`, `rxTime`) VALUES ('System', 'eMail Address Changed','eMail Changed to {{global.to}}', '{{timestamp}}', '{{timestamp}}');","output":"str","x":710,"y":280,"wires":[["d360a4fe.9ebda8"]]},{"id":"d360a4fe.9ebda8","type":"sqlite","z":"b00e2d77.a9931","mydb":"fd38eee5.8bd8a","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":870,"y":280,"wires":[["8469e8af.2a6df8"]]},{"id":"c1530843.813c58","type":"change","z":"b00e2d77.a9931","name":"Time Now","rules":[{"t":"set","p":"timestamp","pt":"msg","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":560,"y":280,"wires":[["2ba16b1b.ca41c4"]]},{"id":"8469e8af.2a6df8","type":"link out","z":"b00e2d77.a9931","name":"","links":["13c2aaaa.74d295","f8b2c7bc.b77368","ed29f70d.9b66f8","f72ff61b.e8d618","9f5ece3e.bbcec"],"x":975,"y":280,"wires":[]},{"id":"2fd00906.8c8cb6","type":"function","z":"b209c94d.26d798","name":"Set Style","func":"var array = msg.payload\nvar i;\nfor (i = 0; i < array.length; i++) { \n    \n  if (msg.payload[i].status == \"Late\") {\n    msg.payload[i].style = \"flash bold\"\n} else {\n    msg.payload[i].style = \"\"\n}\n}\nreturn msg;","outputs":1,"noerr":0,"x":540,"y":260,"wires":[["3945937b.26034c"]]},{"id":"9cb10731.0e0a38","type":"serial in","z":"3b51b3fa.8136dc","name":"","serial":"aae6ab09.c69b28","x":110,"y":100,"wires":[["b47a3123.3b208"]]},{"id":"b47a3123.3b208","type":"switch","z":"3b51b3fa.8136dc","name":"MSG Type","property":"payload","propertyType":"msg","rules":[{"t":"cont","v":"[","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":270,"y":100,"wires":[["bfec026c.c4148"],["d6264d72.9b56e"]]},{"id":"bfec026c.c4148","type":"function","z":"3b51b3fa.8136dc","name":"TRX1 Process Group Message","func":"var payload = msg.payload;\nvar Totallength = payload.length;\n\nvar page = payload.substring(9, Totallength -2);\n\n\nvar str = \"\" + page;\nvar split = str.split(\",\");\nvar contentlength = split[1].length\n\n\n\nvar capcode = split[0];\nvar str = capcode.toString();\nvar strLength = str.length;\nvar pagerStr = str.substring(strLength - 5, strLength);\nvar pagercalc1 = parseInt(pagerStr);\nvar pager = pagercalc1/8;\n\nvar syscode = ((capcode - pagercalc1)-700000)/100000;\n\nif (page.endsWith(\" \")) {\n    var message= split[1].substring(4,contentlength-1)\nvar tidyMessage = message.trim();\n    msg.sender = \"0\"\n} else {\n    var message= split[1].substring(4,contentlength-2)\nvar tidyMessage = message.trim();\n    var sender = split[1].substring(contentlength-2,contentlength)\n    var tidySender = sender.trim();\n    msg.sender = tidySender;\n}\n\nvar group= split[1].substring(0,4)\n\nmsg.capcode = split[0];\nmsg.pagerNumber = group;\nmsg.sysID = syscode\nmsg.content = tidyMessage;\nmsg.payload = page\nreturn msg;","outputs":1,"noerr":0,"x":490,"y":80,"wires":[["7e312125.1eb7b"]]},{"id":"d6264d72.9b56e","type":"function","z":"3b51b3fa.8136dc","name":"TRX1 Process Normal Message","func":"var payload = msg.payload;\nvar Totallength = payload.length;\n\nvar page = payload.substring(9, Totallength -2);\n\n\nvar str = \"\" + page;\nvar split = str.split(\",\");\nvar contentlength = split[1].length\n\n\n\nvar capcode = split[0];\nvar str = capcode.toString();\nvar strLength = str.length;\nvar pagerStr = str.substring(strLength - 5, strLength);\nvar pagercalc1 = parseInt(pagerStr);\nvar pager = pagercalc1/8;\n\nvar syscode = ((capcode - pagercalc1)-700000)/100000;\n\nif (page.endsWith(\" \")) {\n    var message= split[1].substring(0,contentlength-1)\nvar tidyMessage = message.trim();\n    msg.sender = \"0\"\n} else {\n    var message= split[1].substring(0,contentlength-2)\nvar tidyMessage = message.trim();\n    var sender = split[1].substring(contentlength-2,contentlength)\n    var tidySender = sender.trim();\n    msg.sender = tidySender;\n}\n\n\nmsg.capcode = split[0];\nmsg.pagerNumber = pager\nmsg.sysID = syscode\nmsg.content = tidyMessage;\nmsg.payload = page\nreturn msg;","outputs":1,"noerr":0,"x":490,"y":120,"wires":[["7e312125.1eb7b"]]},{"id":"7e312125.1eb7b","type":"function","z":"3b51b3fa.8136dc","name":"Split Content into 2","func":"var payload = msg.content;\n\nvar str = \"\" + payload;\nvar split = str.split(\"-\");\n\nmsg.msgPart1 = split[0];\nmsg.msgPart2 = split[1];\nreturn msg;","outputs":1,"noerr":0,"x":750,"y":100,"wires":[[]]},{"id":"61c3188a.69cf28","type":"template","z":"e3cbac21.52804","name":"Update Active to Handled","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"UPDATE `log` SET status = 'Handled', statusTime = '{{timestamp}}' WHERE `sender` = {{sender}} AND `status` = 'Active';","output":"str","x":710,"y":320,"wires":[["51abf5f2.9454cc"]]},{"id":"51abf5f2.9454cc","type":"sqlite","z":"e3cbac21.52804","mydb":"fd38eee5.8bd8a","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":910,"y":320,"wires":[["fb714f6.286fcb"]]},{"id":"bc4b27b0.6d1478","type":"link out","z":"e3cbac21.52804","name":"to Log","links":["13c2aaaa.74d295","ed29f70d.9b66f8","f72ff61b.e8d618","9f5ece3e.bbcec"],"x":1415,"y":320,"wires":[]},{"id":"fb714f6.286fcb","type":"template","z":"e3cbac21.52804","name":"Update Late to Handled","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"UPDATE `log` SET status = 'Handled', statusTime = '{{timestamp}}' WHERE `sender` = {{sender}} AND `status` = 'Late';","output":"str","x":1110,"y":320,"wires":[["9666bf85.ccc7b"]]},{"id":"9666bf85.ccc7b","type":"sqlite","z":"e3cbac21.52804","mydb":"fd38eee5.8bd8a","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":1310,"y":320,"wires":[["bc4b27b0.6d1478"]]},{"id":"c94a9d48.9c2c","type":"link out","z":"e3cbac21.52804","name":"Add to DB","links":["a7862417.604e88","c7eb5365.d6ebd"],"x":315,"y":160,"wires":[]},{"id":"65be70e.baef89","type":"comment","z":"e3cbac21.52804","name":"Add to DB","info":"","x":140,"y":260,"wires":[]},{"id":"5652483b.e30f08","type":"link out","z":"e3cbac21.52804","name":"to Log","links":["13c2aaaa.74d295","ed29f70d.9b66f8","f72ff61b.e8d618","9f5ece3e.bbcec"],"x":615,"y":360,"wires":[]},{"id":"bb983eee.bde5b","type":"debug","z":"e3cbac21.52804","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":350,"y":120,"wires":[]},{"id":"f00ef931.2b7e68","type":"hostip","z":"60528a1b.f32364","name":"Host IP","x":420,"y":80,"wires":[["88463608.a1be98"]]},{"id":"88463608.a1be98","type":"change","z":"60528a1b.f32364","name":"","rules":[{"t":"set","p":"ip","pt":"global","to":"payload[0].address","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":570,"y":80,"wires":[["38013852.8f7b18"]]},{"id":"66e288bb.f91b28","type":"inject","z":"60528a1b.f32364","name":"Initiate Global Variables","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"onceDelay":"0","x":190,"y":280,"wires":[["f00ef931.2b7e68","16c14cba.135493","7a7e9dde.7b8004","b433b476.f79378","a1416828.f4d808","daaef36b.fd391","4dd7af67.999da","2fabfffb.a95f7","f439405a.85afc","a14d3f9.2f33cc"]]},{"id":"a4a4aa8b.4ca648","type":"change","z":"60528a1b.f32364","name":"","rules":[{"t":"set","p":"sysID","pt":"global","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":560,"y":120,"wires":[[]]},{"id":"16c14cba.135493","type":"DataOut","z":"60528a1b.f32364","collection":"e1c85b2c.abed18","name":"","path":"/email","error":false,"x":410,"y":160,"wires":[["417a42c2.c5f93c"]]},{"id":"417a42c2.c5f93c","type":"change","z":"60528a1b.f32364","name":"","rules":[{"t":"set","p":"to","pt":"global","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":550,"y":160,"wires":[[]]},{"id":"97a59e4.8bf1a6","type":"comment","z":"60528a1b.f32364","name":"Set Email Address","info":"","x":750,"y":160,"wires":[]},{"id":"7568d75d.043c68","type":"comment","z":"60528a1b.f32364","name":"Set sysID","info":"","x":720,"y":120,"wires":[]},{"id":"9a7d50bd.7cef2","type":"comment","z":"60528a1b.f32364","name":"Set IP Address","info":"","x":860,"y":80,"wires":[]},{"id":"7fda91ad.06b69","type":"template","z":"60528a1b.f32364","name":"","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO `log` (`sender`, `status`, `content`, `statusTime`, `rxTime`) VALUES ('System', 'Power On','Power On ({{global.ip}})', '{{payload}}', '{{payload}}');","output":"str","x":580,"y":200,"wires":[["64f95549.289fdc"]]},{"id":"64f95549.289fdc","type":"sqlite","z":"60528a1b.f32364","mydb":"fd38eee5.8bd8a","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":730,"y":200,"wires":[[]]},{"id":"7a7e9dde.7b8004","type":"delay","z":"60528a1b.f32364","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"minute","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"x":430,"y":200,"wires":[["7fda91ad.06b69"]]},{"id":"adbc8745.6a7b98","type":"comment","z":"60528a1b.f32364","name":"Write Power On Message to DB","info":"","x":950,"y":200,"wires":[]},{"id":"38013852.8f7b18","type":"DataIn","z":"60528a1b.f32364","collection":"e1c85b2c.abed18","name":"","update":false,"path":"/ip","x":710,"y":80,"wires":[]},{"id":"8ef3cc6f.9a91a","type":"template","z":"60528a1b.f32364","name":"Left Header","field":"left","fieldType":"global","format":"handlebars","syntax":"mustache","template":"<div class=\"left\">\n    {{#payload}}\n        <a href=\"/{{Address}}\" class=\"settings\">{{Name}}</a>\n        <BR>\n    {{/payload}}\n</div>","output":"str","x":570,"y":520,"wires":[[]]},{"id":"bdee1a5f.1f3dc8","type":"comment","z":"60528a1b.f32364","name":"Set Left Header Links","info":"","x":920,"y":520,"wires":[]},{"id":"b711720e.5994a","type":"change","z":"1c96dbb1.1bc354","name":"Title","rules":[{"t":"set","p":"title","pt":"msg","to":"CaptureCall Full Log","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":470,"y":80,"wires":[["1e62e84c.1602e8"]]},{"id":"35e23daf.3e9492","type":"http response","z":"b209c94d.26d798","name":"","statusCode":"","headers":{},"x":830,"y":80,"wires":[]},{"id":"772432e4.448f2c","type":"template","z":"b209c94d.26d798","name":"HTML","field":"payload","fieldType":"msg","format":"html","syntax":"mustache","template":"<!DOCTYPE html>\n<html>\n<head>\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    \n    <title>{{title}}</title>\n\n    <script>\n        {{{script}}}\n    </script>\n    \n    <style>\n        {{{global.css}}}\n    </style>\n\n</head>\n\n<body onload=\"startTime()\">\n\n<div class=\"heading\">\n          \n    <div class=\"left\">{{{global.left}}}</div>\n    \n    <div class=\"middle\">\n        <h1 id=\"title\">{{title}}</h1>\n    </div>\n    \n    <div class=\"right\">\n        <div class=\"clock\" id=\"time\"></div>\n    </div>\n    \n</div>\n\n<div class=\"wrapper\" id=\"data\">\n\n</div>\n\n</body>\n\n</html>","output":"str","x":710,"y":80,"wires":[["35e23daf.3e9492"]]},{"id":"fd2ae0c5.52933","type":"change","z":"b209c94d.26d798","name":"Title","rules":[{"t":"set","p":"title","pt":"msg","to":"CaptureCall Daily Log","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":470,"y":80,"wires":[["3bae9439.a7642c"]]},{"id":"b433b476.f79378","type":"template","z":"60528a1b.f32364","name":"CSS","field":"css","fieldType":"global","format":"css","syntax":"mustache","template":"* {\n      padding: 0px;\n      margin: 0;\n      box-sizing: border-box;\n      background: #456FA0;\n}\n\nh1 {\n      padding: 10px;\n      text-align: center;\n}\n\nhtml,\nbody,\np {\n      font-family: Arial, Helvetica, sans-serif;\n      font-size: 1vw;\n      margin: 0px;\n      padding-left: 0px;\n      color: white;\n}\n\n.wrapper {\n      display: grid;\n}\n\n.heading {\n      width: 100%;\n      display: grid;\n      grid-template-columns: 25% 50% 25%;\n      grid-gap: 0em;\n      height: auto;\n      padding: 10px;\n}\n\n.left {\n      text-align: left;\n}\n\n.middle {\n      text-align: center;\n}\n\n.right {\n      text-align: right;\n}\n    \n.clock {\n        font-size: 2vw;\n        padding-top:10px;\n        font-weight: bold;\n}\n\n.nested {\n      display: grid;\n      justify-content: space-evenly;\n      align-content: center;\n      grid-template-columns: repeat(6, 1.5fr);\n      font-size: 1.5vw;\n      text-align: center;\n      color: black;\n}\n    \n.nestedLog {\n      display: grid;\n      justify-content: space-evenly;\n      align-content: center;\n      grid-template-columns: repeat(14, 1fr);\n      font-size: 1vw;\n      text-align: center;\n      color: black;\n}\n\n.nested10 {\n      display: grid;\n      justify-content: space-evenly;\n      align-content: center;\n      grid-template-columns: repeat(10, 1fr);\n      font-size: 1vw;\n      text-align: center;\n      color: black;\n}\n\n.wrapper>div {\n      background: #eee;\n      padding: 0.5em;\n}\n\n.wrapper>div:nth-child(odd) {\n      background: #ddd;\n}\n\n.nested>div {\n      padding: 0.5em;\n      background-color: inherit;\n}\n    \n.nestedLog>div {\n      padding: 0.5em;\n      background-color: inherit;\n}\n\n.nested10>div {\n      padding: 0.5em;\n      background-color: inherit;\n}\n\n.bold {\n      font-weight: bold;    \n}\n\n.flash {\n      color: red;\n}\n    \n\n.red {\n      color: red;\n}\n\n    a:link {\n      text-decoration: none;\n      color: white;\n    }\n\n    a:visited {\n      text-decoration: none;\n      color: white;\n    }\n\n    a:hover {\n      color: red;\n    }\n    \n#notes {\n    font-size: 1.5vw;\n}\n       .grid-container {\n            display: grid;\n            grid-template-columns: auto;\n            padding: 0px;\n        }\n\n        .grid-item {\n            padding: 20px;\n            font-size: 48px;\n            text-align: center;\n        }\n        \n.name {\n            box-sizing: border-box;\n            width: 50%;\n            border-radius: 10px;\n            font-weight: normal;\n            font-size: 1vw;\n            font-family: Arial, Helvetica, sans-serif;\n            text-align: center;\n            padding: 10px;\n            margin: 0px;\n            text-overflow: ellipsis;\n            box-shadow: 10px 10px 20px black;\n            background-color: lightgrey;\n }\n \n.V {\n}\n.V1 {\n        color: green;\n    font-size: 1.7vw;\n}\n\n.V2 {\n}\n\n.V3 {\n}\n.B {\n\n}\n.B1 {\n}\n\n.B2 {\n}\n\n.B3 {\n}\n\n.VB1 {\n    font-weight: bold; \n    color: red;\n}\n\n.VB2 {\n}\n\n.VB3 {\n}\n.B1b3 {\n}\n","output":"str","x":410,"y":280,"wires":[[]]},{"id":"1250eb2c.91a835","type":"comment","z":"60528a1b.f32364","name":"Set CSS","info":"","x":580,"y":280,"wires":[]},{"id":"5d9f879a.ab2cf8","type":"http response","z":"b00e2d77.a9931","name":"","statusCode":"","headers":{},"x":770,"y":80,"wires":[]},{"id":"4e44e038.08395","type":"template","z":"b00e2d77.a9931","name":"HTML","field":"payload","fieldType":"msg","format":"html","syntax":"mustache","template":"<!DOCTYPE html>\n<html>\n<head>\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    \n    <title>{{title}}</title>\n\n    <script>\n        {{{script}}}\n    </script>\n    \n    <style>\n        {{{global.css}}}\n    </style>\n\n</head>\n\n<body onload=\"startTime()\">\n\n<div class=\"heading\">\n          \n    <div class=\"left\">{{{global.left}}}</div>\n    \n    <div class=\"middle\">\n        <h1 id=\"title\">{{title}}</h1>\n    </div>\n    \n    <div class=\"right\">\n        <div class=\"clock\" id=\"time\"></div>\n    </div>\n    \n</div>\n\n<div class=\"wrapper\" id=\"data\">\n\n</div>\n\n</body>\n\n</html>","output":"str","x":650,"y":80,"wires":[["5d9f879a.ab2cf8"]]},{"id":"cf30e34b.c1eb2","type":"change","z":"b00e2d77.a9931","name":"Title","rules":[{"t":"set","p":"title","pt":"msg","to":"CaptureCall Export Menu","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":410,"y":80,"wires":[["72aa7d10.d1af44"]]},{"id":"29aa4748.4a38f8","type":"change","z":"60528a1b.f32364","name":"","rules":[{"t":"set","p":"serial","pt":"global","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":560,"y":320,"wires":[[]]},{"id":"daaef36b.fd391","type":"DataOut","z":"60528a1b.f32364","collection":"e1c85b2c.abed18","name":"","path":"/sw","error":false,"x":410,"y":360,"wires":[["92ab9cbc.b90cc"]]},{"id":"92ab9cbc.b90cc","type":"change","z":"60528a1b.f32364","name":"","rules":[{"t":"set","p":"sw","pt":"global","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":550,"y":360,"wires":[[]]},{"id":"43bab4a0.45f19c","type":"comment","z":"60528a1b.f32364","name":"Set S/W Version","info":"","x":740,"y":360,"wires":[]},{"id":"a1416828.f4d808","type":"DataOut","z":"60528a1b.f32364","collection":"e1c85b2c.abed18","name":"","path":"/serial","error":false,"x":410,"y":320,"wires":[["29aa4748.4a38f8"]]},{"id":"43ccf7d3.ddd008","type":"comment","z":"60528a1b.f32364","name":"Set Serial","info":"","x":720,"y":320,"wires":[]},{"id":"4dd7af67.999da","type":"DataOut","z":"60528a1b.f32364","collection":"e1c85b2c.abed18","name":"","path":"/hw","error":false,"x":410,"y":400,"wires":[["2d58c279.e4542e"]]},{"id":"2d58c279.e4542e","type":"change","z":"60528a1b.f32364","name":"","rules":[{"t":"set","p":"hw","pt":"global","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":550,"y":400,"wires":[[]]},{"id":"5b43db00.7c2cc4","type":"comment","z":"60528a1b.f32364","name":"Set H/W Version","info":"","x":740,"y":400,"wires":[]},{"id":"2fabfffb.a95f7","type":"DataOut","z":"60528a1b.f32364","collection":"e1c85b2c.abed18","name":"","path":"/fw","error":false,"x":410,"y":440,"wires":[["2563249f.b0948c"]]},{"id":"2563249f.b0948c","type":"change","z":"60528a1b.f32364","name":"","rules":[{"t":"set","p":"fw","pt":"global","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":550,"y":440,"wires":[[]]},{"id":"158ee839.e5b868","type":"comment","z":"60528a1b.f32364","name":"Set F/W Version","info":"","x":740,"y":440,"wires":[]},{"id":"5a4c919f.6aef9","type":"DataIn","z":"60528a1b.f32364","collection":"e1c85b2c.abed18","name":"","update":false,"path":"/serial","x":610,"y":620,"wires":[]},{"id":"558730dd.1c8c7","type":"inject","z":"60528a1b.f32364","name":"","topic":"","payload":"SerialNumber","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":470,"y":620,"wires":[["5a4c919f.6aef9"]]},{"id":"dbf96854.54d538","type":"DataIn","z":"60528a1b.f32364","collection":"e1c85b2c.abed18","name":"","update":false,"path":"/sw","x":610,"y":660,"wires":[]},{"id":"80cd3c13.c8202","type":"inject","z":"60528a1b.f32364","name":"","topic":"","payload":"1.0.0","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":450,"y":660,"wires":[["dbf96854.54d538","68f92468.fbc08c","3df1c746.549888"]]},{"id":"68f92468.fbc08c","type":"DataIn","z":"60528a1b.f32364","collection":"e1c85b2c.abed18","name":"","update":false,"path":"/hw","x":610,"y":700,"wires":[]},{"id":"3df1c746.549888","type":"DataIn","z":"60528a1b.f32364","collection":"e1c85b2c.abed18","name":"","update":false,"path":"/fw","x":610,"y":740,"wires":[]},{"id":"89ede062.46b22","type":"comment","z":"b00e2d77.a9931","name":"Put Settings On the Webpage","info":"","x":140,"y":140,"wires":[]},{"id":"a29f518.92ac7b","type":"websocket out","z":"b00e2d77.a9931","name":"","server":"b7dfd67b.7d7948","client":"","x":570,"y":180,"wires":[]},{"id":"1228ef46.2a9871","type":"template","z":"b00e2d77.a9931","name":"Build Data","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<div class=\"grid-container\">\n<div class=\"grid-item\"><p class=\"notes\">Logs are sent to the email address shown below.<br>To update the email address, enter a new address below and press enter.</p><input type=\"email\" class=\"name\" id=\"email\" onchange=\"send.send(email.value)\" placeholder=\"{{global.to}}\"></div>\n<div class=\"grid-item\"><p class=\"notes\">Click on the buttons below to email the relevant report immediately.</p><button class=\"name\" onclick=\"send.send('ExportNew')\">Export New (Unexported) Log Records</button></div>\n<div class=\"grid-item\"><button class=\"name\" onclick=\"send.send('ExportAll')\">Export All Log Records</button></div>\n<div class=\"grid-item\"><button class=\"name\" onclick=\"send.send('ExportUSB')\">Export to USB</button></div>\n<div class=\"grid-item\"><p class=\"notes bold\">WARNING: This cannot be undone!</p><button class=\"name red\" onclick=\"send.send('Clear')\">Delete ALL Exported Records from Log</button></div>\n<div class=\"grid-item\"><p class=\"notes bold\">WARNING: You will need to physically disconnect and then re-connect power to CaptureCall in order to power-up again.</p><button class=\"name red\" onclick=\"send.send('Shutdown')\">Safely Shutdown CaptureCall</button></div>\n</div>","output":"str","x":390,"y":180,"wires":[["a29f518.92ac7b"]]},{"id":"f72ff61b.e8d618","type":"link in","z":"b00e2d77.a9931","name":"log","links":["363f5c70.e7e144","320906f1.fd1fba","ecbc4376.b117e","d2d8b8d2.67e9a8","8469e8af.2a6df8","2c38eaf2.df6f76","bc4b27b0.6d1478","5652483b.e30f08","e14222d1.c9cb7"],"x":275,"y":220,"wires":[["1228ef46.2a9871"]]},{"id":"2e977b67.7b7c54","type":"websocket in","z":"b00e2d77.a9931","name":"","server":"c78d8a51.8b8ed8","client":"","x":100,"y":180,"wires":[["e979859b.b1bd58"]]},{"id":"e979859b.b1bd58","type":"switch","z":"b00e2d77.a9931","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"Open","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":250,"y":180,"wires":[["1228ef46.2a9871"]]},{"id":"1e62e84c.1602e8","type":"template","z":"1c96dbb1.1bc354","name":"Script","field":"script","fieldType":"msg","format":"javascript","syntax":"plain","template":"var receive = new WebSocket('ws://' + location.host + '/log-full/receive');\nvar send = new WebSocket('ws://' + location.host + '/log-full/send');\nvar popup = new WebSocket('ws://' + location.host + '/log-full/alert');\n\n\nvar msg = 0; // Make Incoming WS Global\n\n// Change Main Data\nreceive.onmessage = function(d) {\n    var txt = d.data;\n    msg = JSON.parse(txt);\n    console.log(msg);\n    document.getElementById(\"data\").innerHTML = msg.payload;\n};\n\n// Display Popup\npopup.onmessage = function(d) {\n    var txt = d.data;\n   alert(txt);\n};\n        \n// When the connection is open, send some data to the server\nsend.onopen = function() {\n    console.log('WebSocket Open');\n    send.send('Open');\n};\n\n\nfunction startTime() { //Clock\n    var today = new Date();\n    var h = today.getHours();\n    var m = today.getMinutes();\n    var s = today.getSeconds();\n    m = checkTime(m);\n    s = checkTime(s);\n    document.getElementById('time').innerHTML = h + \":\" + m + \":\" + s;\n    var t = setTimeout(startTime, 500);\n} \n\nfunction checkTime(i) {\n    if (i < 10) {i = \"0\" + i}  // add zero in front of numbers < 10\n    return i;\n}","output":"str","x":590,"y":80,"wires":[["22c6aed.a374c52"]]},{"id":"3bae9439.a7642c","type":"template","z":"b209c94d.26d798","name":"Script","field":"script","fieldType":"msg","format":"javascript","syntax":"plain","template":"var receive = new WebSocket('ws://' + location.host + '/log-daily/receive');\nvar send = new WebSocket('ws://' + location.host + '/log-daily/send');\nvar popup = new WebSocket('ws://' + location.host + '/log-daily/alert');\n\n\nvar msg = 0; // Make Incoming WS Global\n\n// Change Main Data\nreceive.onmessage = function(d) {\n    var txt = d.data;\n    msg = JSON.parse(txt);\n    console.log(msg);\n    document.getElementById(\"data\").innerHTML = msg.payload;\n};\n\n// Display Popup\npopup.onmessage = function(d) {\n    var txt = d.data;\n   alert(txt);\n};\n        \n// When the connection is open, send some data to the server\nsend.onopen = function() {\n    console.log('WebSocket Open');\n    send.send('Open');\n};\n\n\nfunction startTime() { //Clock\n    var today = new Date();\n    var h = today.getHours();\n    var m = today.getMinutes();\n    var s = today.getSeconds();\n    m = checkTime(m);\n    s = checkTime(s);\n    document.getElementById('time').innerHTML = h + \":\" + m + \":\" + s;\n    var t = setTimeout(startTime, 500);\n} \n\nfunction checkTime(i) {\n    if (i < 10) {i = \"0\" + i}  // add zero in front of numbers < 10\n    return i;\n}","output":"str","x":590,"y":80,"wires":[["772432e4.448f2c"]]},{"id":"72aa7d10.d1af44","type":"template","z":"b00e2d77.a9931","name":"Script","field":"script","fieldType":"msg","format":"javascript","syntax":"plain","template":"var receive = new WebSocket('ws://' + location.host + '/export/receive');\nvar send = new WebSocket('ws://' + location.host + '/export/send');\nvar popup = new WebSocket('ws://' + location.host + '/export/alert');\n\n\nvar msg = 0; // Make Incoming WS Global\n\n// Change Main Data\nreceive.onmessage = function(d) {\n    var txt = d.data;\n    msg = JSON.parse(txt);\n    console.log(msg);\n    document.getElementById(\"data\").innerHTML = msg.payload;\n};\n\n// Display Popup\npopup.onmessage = function(d) {\n    var txt = d.data;\n     msg = JSON.parse(txt);\n   alert(msg.payload);\n};\n        \n// When the connection is open, send some data to the server\nsend.onopen = function() {\n    console.log('WebSocket Open');\n    send.send('Open');\n};\n\n\nfunction startTime() { //Clock\n    var today = new Date();\n    var h = today.getHours();\n    var m = today.getMinutes();\n    var s = today.getSeconds();\n    m = checkTime(m);\n    s = checkTime(s);\n    document.getElementById('time').innerHTML = h + \":\" + m + \":\" + s;\n    var t = setTimeout(startTime, 500);\n} \n\nfunction checkTime(i) {\n    if (i < 10) {i = \"0\" + i}  // add zero in front of numbers < 10\n    return i;\n}","output":"str","x":530,"y":80,"wires":[["4e44e038.08395"]]},{"id":"333e0a94.5678c6","type":"template","z":"b00e2d77.a9931","name":"Clear","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"DELETE FROM `log` WHERE `exported` IS NOT NULL;","output":"str","x":450,"y":560,"wires":[["1237ea0d.215136"]]},{"id":"3e94fc51.b74054","type":"switch","z":"b00e2d77.a9931","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"Open","vt":"str"},{"t":"eq","v":"ExportNew","vt":"str"},{"t":"eq","v":"ExportAll","vt":"str"},{"t":"eq","v":"ExportUSB","vt":"str"},{"t":"eq","v":"Clear","vt":"str"},{"t":"eq","v":"Shutdown","vt":"str"},{"t":"cont","v":"@","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":8,"x":270,"y":540,"wires":[[],["cf368fd3.b1f24"],["296e6582.99004a"],["9ebb47d8.f65978"],["333e0a94.5678c6"],["647efa55.c6e874"],["232317a3.5e58f8"],["11b0c0ec.55df3f"]]},{"id":"1237ea0d.215136","type":"sqlite","z":"b00e2d77.a9931","mydb":"fd38eee5.8bd8a","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":590,"y":560,"wires":[["e535dae8.dcfae8"]]},{"id":"34c0e145.1bf84e","type":"exec","z":"b00e2d77.a9931","command":"shutdown -P now","addpay":false,"append":"","useSpawn":"","timer":"","oldrc":false,"name":"","x":810,"y":600,"wires":[["7997db1e.abf2d4"],["7997db1e.abf2d4"],["7997db1e.abf2d4"]]},{"id":"48285347.2903fc","type":"delay","z":"b00e2d77.a9931","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":640,"y":600,"wires":[["34c0e145.1bf84e"]]},{"id":"64248c60.900b94","type":"websocket in","z":"b00e2d77.a9931","name":"","server":"c78d8a51.8b8ed8","client":"","x":100,"y":540,"wires":[["3e94fc51.b74054"]]},{"id":"e813c8d.549c038","type":"websocket out","z":"b00e2d77.a9931","name":"Show Alert for Shutdown","server":"18f900b5.35f87f","client":"","x":690,"y":680,"wires":[]},{"id":"647efa55.c6e874","type":"change","z":"b00e2d77.a9931","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"CaptureCall is Shutting Down... Please Close your Browser (If Necessary)","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":480,"y":600,"wires":[["e813c8d.549c038","48285347.2903fc","5de24333.2d962c"]]},{"id":"e535dae8.dcfae8","type":"change","z":"b00e2d77.a9931","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"Records Deleted","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":780,"y":560,"wires":[["9e88663e.111128","7d6ca1a9.1c4e1"]]},{"id":"9e88663e.111128","type":"websocket out","z":"b00e2d77.a9931","name":"Show Alert for Clear Database","server":"18f900b5.35f87f","client":"","x":1010,"y":560,"wires":[]},{"id":"8f982cce.d9f72","type":"template","z":"b00e2d77.a9931","name":"","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO `log` (`sender`, `status`, `content`, `statusTime`, `rxTime`) VALUES ('System', 'Power Off','Power Off', '{{timestamp}}', '{{timestamp}}');","output":"str","x":780,"y":640,"wires":[["986f3937.af7a18"]]},{"id":"986f3937.af7a18","type":"sqlite","z":"b00e2d77.a9931","mydb":"fd38eee5.8bd8a","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":930,"y":640,"wires":[[]]},{"id":"8dc6af04.088a3","type":"link out","z":"b00e2d77.a9931","name":"","links":["86082327.d62aa"],"x":875,"y":440,"wires":[]},{"id":"9b0374d2.8917a8","type":"link out","z":"b00e2d77.a9931","name":"","links":["223b37e8.4b69d8"],"x":875,"y":480,"wires":[]},{"id":"232317a3.5e58f8","type":"link out","z":"b00e2d77.a9931","name":"","links":["a20fe9c4.7efc28"],"x":415,"y":640,"wires":[]},{"id":"11b0c0ec.55df3f","type":"link out","z":"b00e2d77.a9931","name":"","links":["c31b6340.5e646"],"x":415,"y":680,"wires":[]},{"id":"d27040b1.bd22","type":"comment","z":"b00e2d77.a9931","name":"Handle Input from Webpage","info":"","x":140,"y":440,"wires":[]},{"id":"5de24333.2d962c","type":"change","z":"b00e2d77.a9931","name":"Time Now","rules":[{"t":"set","p":"timestamp","pt":"msg","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":640,"y":640,"wires":[["8f982cce.d9f72"]]},{"id":"878807fc.17f708","type":"template","z":"b00e2d77.a9931","name":"Log Export","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO `log` (`sender`, `status`, `content`, `statusTime`, `rxTime`) VALUES ('System', 'Export All','Export All to {{global.to}}', '{{timestamp}}', '{{timestamp}}');","output":"str","x":610,"y":480,"wires":[["36c49da8.b2b1c2"]]},{"id":"36c49da8.b2b1c2","type":"sqlite","z":"b00e2d77.a9931","mydb":"fd38eee5.8bd8a","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":770,"y":480,"wires":[["9b0374d2.8917a8"]]},{"id":"3e07d8e1.991e78","type":"template","z":"b00e2d77.a9931","name":"Log Export","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO `log` (`sender`, `status`, `content`, `statusTime`, `rxTime`) VALUES ('System', 'Export New','Export New to {{global.to}}', '{{timestamp}}', '{{timestamp}}');","output":"str","x":610,"y":440,"wires":[["6886cec4.f705c"]]},{"id":"6886cec4.f705c","type":"sqlite","z":"b00e2d77.a9931","mydb":"fd38eee5.8bd8a","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":770,"y":440,"wires":[["8dc6af04.088a3"]]},{"id":"cf368fd3.b1f24","type":"change","z":"b00e2d77.a9931","name":"Time Now","rules":[{"t":"set","p":"timestamp","pt":"msg","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":460,"y":440,"wires":[["3e07d8e1.991e78"]]},{"id":"296e6582.99004a","type":"change","z":"b00e2d77.a9931","name":"Time Now","rules":[{"t":"set","p":"timestamp","pt":"msg","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":460,"y":480,"wires":[["878807fc.17f708"]]},{"id":"7d6ca1a9.1c4e1","type":"change","z":"b00e2d77.a9931","name":"Time Now","rules":[{"t":"set","p":"timestamp","pt":"msg","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":940,"y":520,"wires":[["ec8b3b9a.789898"]]},{"id":"ec8b3b9a.789898","type":"template","z":"b00e2d77.a9931","name":"","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO `log` (`sender`, `status`, `content`, `statusTime`, `rxTime`) VALUES ('System', 'Records Deleted','Records Deleted', '{{timestamp}}', '{{timestamp}}');","output":"str","x":1080,"y":520,"wires":[["c6034db6.a65e"]]},{"id":"c6034db6.a65e","type":"sqlite","z":"b00e2d77.a9931","mydb":"fd38eee5.8bd8a","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":1230,"y":520,"wires":[[]]},{"id":"f439405a.85afc","type":"DataOut","z":"60528a1b.f32364","collection":"e1c85b2c.abed18","name":"","path":"/password","error":false,"x":430,"y":480,"wires":[["2d0f23a.2359bdc"]]},{"id":"2d0f23a.2359bdc","type":"change","z":"60528a1b.f32364","name":"","rules":[{"t":"set","p":"password","pt":"global","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":620,"y":480,"wires":[[]]},{"id":"78addd47.975844","type":"comment","z":"60528a1b.f32364","name":"Set Password","info":"","x":810,"y":480,"wires":[]},{"id":"bfcf2e37.054ff","type":"DataIn","z":"60528a1b.f32364","collection":"e1c85b2c.abed18","name":"","update":false,"path":"/password","x":630,"y":580,"wires":[]},{"id":"f2ffd251.d4288","type":"inject","z":"60528a1b.f32364","name":"","topic":"","payload":"1234","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":450,"y":580,"wires":[["bfcf2e37.054ff"]]},{"id":"a14d3f9.2f33cc","type":"DataOut","z":"60528a1b.f32364","collection":"e1c85b2c.abed18","name":"","path":"/modules","error":false,"x":420,"y":520,"wires":[["8ef3cc6f.9a91a"]]},{"id":"fd4ba03e.ba97d","type":"comment","z":"60528a1b.f32364","name":"Set Modules","info":"","x":730,"y":520,"wires":[]},{"id":"6b29ff98.c2dac","type":"DataIn","z":"60528a1b.f32364","collection":"e1c85b2c.abed18","name":"","update":false,"path":"/modules","x":620,"y":780,"wires":[]},{"id":"2a2fcdb2.0edcd2","type":"inject","z":"60528a1b.f32364","name":"","topic":"","payload":"[{\"Name\":\"Go to Dynamic Display\",\"Address\":\"display\"},{\"Name\":\"Go to Daily Log\",\"Address\":\"log-daily\"},{\"Name\":\"Go to Full Log\",\"Address\":\"log-full\"},{\"Name\":\"Go to Export Menu\",\"Address\":\"export\"}]","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":490,"y":780,"wires":[["6b29ff98.c2dac"]]},{"id":"7aa6b39d.f2722c","type":"http response","z":"60528a1b.f32364","name":"","statusCode":"","headers":{},"x":530,"y":880,"wires":[]},{"id":"95a0170a.fdab58","type":"template","z":"60528a1b.f32364","name":"HTML","field":"payload","fieldType":"msg","format":"html","syntax":"mustache","template":"<!DOCTYPE html>\n<html>\n<head>\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    \n    <title>{{title}}</title>\n\n    <script>\n        {{{script}}}\n    </script>\n    \n    <style>\n        {{{global.css}}}\n    </style>\n\n</head>\n\n<body onload=\"startTime()\">\n\n<div class=\"heading\">\n          \n    <div class=\"left\">{{{global.left}}}</div>\n    \n    <div class=\"middle\">\n        <h1 id=\"title\">{{title}}</h1>\n    </div>\n    \n    <div class=\"right\">\n        <div class=\"clock\" id=\"time\"></div>\n    </div>\n    \n</div>\n\n<div class=\"wrapper\" id=\"data\">\nSorry your not able to access this page\n</div>\n\n</body>\n\n</html>","output":"str","x":410,"y":880,"wires":[["7aa6b39d.f2722c"]]},{"id":"102ab00f.0b28b","type":"change","z":"60528a1b.f32364","name":"Title","rules":[{"t":"set","p":"title","pt":"msg","to":"CaptureCall Unavaliable Module","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":170,"y":880,"wires":[["6ec81c61.061cd4"]]},{"id":"6ec81c61.061cd4","type":"template","z":"60528a1b.f32364","name":"Script","field":"script","fieldType":"msg","format":"javascript","syntax":"plain","template":"var receive = new WebSocket('ws://' + location.host + '/display/receive');\nvar send = new WebSocket('ws://' + location.host + '/display/send');\nvar popup = new WebSocket('ws://' + location.host + '/display/alert');\n\n\nvar msg = 0; // Make Incoming WS Global\n\n// Change Main Data\nreceive.onmessage = function(d) {\n    var txt = d.data;\n    msg = JSON.parse(txt);\n    console.log(msg);\n    document.getElementById(\"data\").innerHTML = msg.payload;\n};\n\n// Display Popup\npopup.onmessage = function(d) {\n    var txt = d.data;\n   alert(txt);\n};\n        \n// When the connection is open, send some data to the server\nsend.onopen = function() {\n    console.log('WebSocket Open');\n    send.send('Open');\n};\n\n\nfunction startTime() { //Clock\n    var today = new Date();\n    var h = today.getHours();\n    var m = today.getMinutes();\n    var s = today.getSeconds();\n    m = checkTime(m);\n    s = checkTime(s);\n    document.getElementById('time').innerHTML = h + \":\" + m + \":\" + s;\n    var t = setTimeout(startTime, 500);\n} \n\nfunction checkTime(i) {\n    if (i < 10) {i = \"0\" + i}  // add zero in front of numbers < 10\n    return i;\n}","output":"str","x":290,"y":880,"wires":[["95a0170a.fdab58"]]},{"id":"f13a1f16.82872","type":"link in","z":"60528a1b.f32364","name":"Not Licenced","links":["34ba01df.30c98e","981f0079.8aed3","ae2f0aa6.b83788","c1934064.6743e","3ef1e38d.001f0c"],"x":75,"y":880,"wires":[["102ab00f.0b28b"]]},{"id":"34ba01df.30c98e","type":"link out","z":"1c96dbb1.1bc354","name":"Not Licenced","links":["f13a1f16.82872"],"x":435,"y":120,"wires":[]},{"id":"6ca3eb83.432e44","type":"comment","z":"60528a1b.f32364","name":"Unlicenced Module Webpage","info":"","x":180,"y":840,"wires":[]},{"id":"981f0079.8aed3","type":"link out","z":"b209c94d.26d798","name":"Not Licenced","links":["f13a1f16.82872"],"x":435,"y":120,"wires":[]},{"id":"ae2f0aa6.b83788","type":"link out","z":"b00e2d77.a9931","name":"Not Licenced","links":["f13a1f16.82872"],"x":395,"y":120,"wires":[]},{"id":"57140bc4.737114","type":"template","z":"b00e2d77.a9931","name":"Log Export","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO `log` (`sender`, `status`, `content`, `statusTime`, `rxTime`) VALUES ('System', 'ExportUSB','Export All to USB', '{{timestamp}}', '{{timestamp}}');","output":"str","x":610,"y":520,"wires":[["aa2c8114.eb4a8"]]},{"id":"aa2c8114.eb4a8","type":"sqlite","z":"b00e2d77.a9931","mydb":"fd38eee5.8bd8a","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":770,"y":520,"wires":[["2a3fe792.b505c8"]]},{"id":"9ebb47d8.f65978","type":"change","z":"b00e2d77.a9931","name":"Time Now","rules":[{"t":"set","p":"timestamp","pt":"msg","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":460,"y":520,"wires":[["57140bc4.737114"]]},{"id":"2a3fe792.b505c8","type":"template","z":"b00e2d77.a9931","name":"Export All","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"SELECT \n`index` AS 'Index',\n`sender` AS 'Call Point',\n`content` AS 'Message',\n`rxTime`,\n`status` AS 'Status',\n`statusTime`,\n`exported`,\n`pagerNumber` AS 'Recipient',\n`sysID` AS 'System ID'\nFROM `log`\nORDER BY  `rxTime` DESC;","output":"str","x":980,"y":480,"wires":[["f18406a.f7faef8"]]},{"id":"f18406a.f7faef8","type":"sqlite","z":"b00e2d77.a9931","mydb":"fd38eee5.8bd8a","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":1130,"y":480,"wires":[["390160a5.8ab92"]]},{"id":"390160a5.8ab92","type":"function","z":"b00e2d77.a9931","name":"Convert Time to local","func":"var array = msg.payload\nvar i;\nfor (i = 0; i < array.length; i++) { \nvar rxtime = new Date(msg.payload[i].rxTime);\nvar statusTime = new Date(msg.payload[i].statusTime);\nvar exportedTime = new Date(msg.payload[i].exported);\n\nif (msg.payload[i].exported === null) {\n    msg.payload[i].ExportedTime = \"n/a\"\n} else {\nmsg.payload[i].ExportedTime = exportedTime\n}\n\nmsg.payload[i].StatusTime = statusTime\nmsg.payload[i].ReceivedTime = rxtime\n}\n    \n \n\nreturn msg;","outputs":1,"noerr":0,"x":1320,"y":480,"wires":[["ae68ab8d.892138"]]},{"id":"ae68ab8d.892138","type":"csv","z":"b00e2d77.a9931","name":"","sep":",","hdrin":"","hdrout":true,"multi":"one","ret":"\\n","temp":"Index, Call Point, Message, ReceivedTime, Status, StatusTime, ExportedTime, Recipient, System ID","skip":"0","x":1490,"y":480,"wires":[["37d0780.6d43088"]]},{"id":"6718e06d.1a7ba","type":"file","z":"b00e2d77.a9931","name":"","filename":"","appendNewline":false,"createDir":true,"overwriteFile":"true","x":1750,"y":480,"wires":[["8733b6b6.ceecc8","5976af7.cc2d25"]]},{"id":"37d0780.6d43088","type":"template","z":"b00e2d77.a9931","name":"","field":"filename","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"/media/usb0/log/{{timestamp}}.csv","output":"str","x":1620,"y":480,"wires":[["6718e06d.1a7ba"]]},{"id":"df0dd902.e39c78","type":"catch","z":"b00e2d77.a9931","name":"","scope":["6718e06d.1a7ba"],"x":1750,"y":440,"wires":[["5c219c0f.48fa14","b5112973.1619b8"]]},{"id":"bc5cc87f.5767a8","type":"websocket out","z":"b00e2d77.a9931","name":"Show Alert for File Error","server":"18f900b5.35f87f","client":"","x":2150,"y":460,"wires":[]},{"id":"5c219c0f.48fa14","type":"change","z":"b00e2d77.a9931","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"Error exporting to USB, Please check USB Stick is inserted","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1920,"y":440,"wires":[["bc5cc87f.5767a8","88debd97.7e53e"]]},{"id":"8733b6b6.ceecc8","type":"change","z":"b00e2d77.a9931","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"Export Complete","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1920,"y":480,"wires":[["bc5cc87f.5767a8","88debd97.7e53e"]]},{"id":"5976af7.cc2d25","type":"debug","z":"b00e2d77.a9931","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1890,"y":520,"wires":[]},{"id":"b5112973.1619b8","type":"debug","z":"b00e2d77.a9931","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1890,"y":400,"wires":[]},{"id":"88debd97.7e53e","type":"debug","z":"b00e2d77.a9931","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":2130,"y":540,"wires":[]},{"id":"18ef9926.ad6897","type":"comment","z":"3b51b3fa.8136dc","name":"Receive Page WiTOPTech","info":"","x":150,"y":60,"wires":[]},{"id":"b87ce58f.a17ea8","type":"comment","z":"85d51a2d.db2228","name":"Receive Page SDR","info":"","x":130,"y":20,"wires":[]},{"id":"7997db1e.abf2d4","type":"debug","z":"b00e2d77.a9931","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1020,"y":600,"wires":[]},{"id":"9fd61880.516a68","type":"comment","z":"23c43518.b3ff0a","name":"Put Unprocessed On the Webpage","info":"","x":180,"y":140,"wires":[]},{"id":"409c8cb4.786734","type":"http in","z":"23c43518.b3ff0a","name":"","url":"/display","method":"get","upload":false,"swaggerDoc":"","x":110,"y":100,"wires":[["5e777687.bf0378"]]},{"id":"ebcd4c65.6046a","type":"template","z":"23c43518.b3ff0a","name":"Select Active Data","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"SELECT `index`, `pagerNumber`, `sysID`, `content`, `msgPart1`, `msgPart2`, `sender`, `rxTime`, `status`, `FP`\nFROM `log`\nWHERE  `status` = 'Active' OR `status` = 'Late'\nORDER BY  `rxTime` DESC ","output":"str","x":290,"y":200,"wires":[["66291f5f.af93b"]]},{"id":"6264593.4e61aa8","type":"websocket out","z":"23c43518.b3ff0a","name":"","server":"d9d1357a.d4f118","client":"","x":1340,"y":200,"wires":[]},{"id":"dca11650.a5a9e8","type":"comment","z":"23c43518.b3ff0a","name":"Build Webpage","info":"","x":120,"y":20,"wires":[]},{"id":"66291f5f.af93b","type":"sqlite","z":"23c43518.b3ff0a","mydb":"fd38eee5.8bd8a","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":470,"y":200,"wires":[["16a49dc6.39c7b2"]]},{"id":"75cd0257.5b5c8c","type":"template","z":"23c43518.b3ff0a","name":"Build Data","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"  <div class=\"nested\">\n        <div class=\"bold\">Index</div>\n        <div class=\"bold\">Location</div>\n        <div class=\"bold\">Message</div>\n        <div class=\"bold\">Time</div>\n        <div class=\"bold\">Date</div>\n        <div class=\"bold\">Elapsed</div>\n      </div>\n      \n{{#payload}}\n  <div class=\"nested {{style}}\" onclick= send.send('{{index}}')>\n        <div>{{{index}}}</div>\n        <div>{{{msgPart1}}}</div>\n        <div>{{{msgPart2}}}</div>\n        <div>{{{displayTime}}}</div>\n        <div>{{{displayDate}}}</div>\n        <div>{{{elapsed}}}</div>\n      </div>\n{{/payload}}","output":"str","x":1150,"y":200,"wires":[["6264593.4e61aa8"]]},{"id":"5ea79923.89c6a8","type":"function","z":"23c43518.b3ff0a","name":"Convert Time to local","func":"var array = msg.payload\nvar i;\nfor (i = 0; i < array.length; i++) { \n   var rxtime = new Date(msg.payload[i].rxTime);\n                var displayDate = rxtime.toLocaleDateString();\n                var displayTime = rxtime.toLocaleTimeString();\n                \n                msg.payload[i].displayDate = displayDate\n                msg.payload[i].displayTime = displayTime\n}\n    \n \n\nreturn msg;","outputs":1,"noerr":0,"x":800,"y":200,"wires":[["ce83b6ba.b91948"]]},{"id":"ce83b6ba.b91948","type":"function","z":"23c43518.b3ff0a","name":"Time elapsed","func":"var array = msg.payload\nvar i;\nfor (i = 0; i < array.length; i++) { \n   var rxtime = msg.payload[i].rxTime;\n   var now = Date.now();\n   \nvar elapsedTS = now -rxtime;\nvar elapsedS = parseInt(elapsedTS / 1000);\n\nvar date = new Date(null);  \ndate.setSeconds(elapsedS); // specify value for SECONDS here\nvar elapsed = date.toISOString().substr(11, 8);        \n\nmsg.payload[i].elapsed = elapsed\n\n}\n    \n \n\nreturn msg;","outputs":1,"noerr":0,"x":990,"y":200,"wires":[["75cd0257.5b5c8c"]]},{"id":"5c4d6c4d.b2cf34","type":"inject","z":"23c43518.b3ff0a","name":"","topic":"","payload":"","payloadType":"date","repeat":"1","crontab":"","once":false,"onceDelay":0.1,"x":110,"y":200,"wires":[["ebcd4c65.6046a"]]},{"id":"6cdc803d.e7a58","type":"http in","z":"23c43518.b3ff0a","name":"","url":"/","method":"get","upload":false,"swaggerDoc":"","x":90,"y":60,"wires":[["5e777687.bf0378"]]},{"id":"c0f55161.eb2e9","type":"websocket in","z":"23c43518.b3ff0a","name":"","server":"95962f80.19ef3","client":"","x":130,"y":300,"wires":[["d47e3460.18a298"]]},{"id":"e4b4571a.fa0ca8","type":"comment","z":"23c43518.b3ff0a","name":"Hide Message on Click","info":"","x":140,"y":260,"wires":[]},{"id":"3dc80a3a.37f5b6","type":"template","z":"23c43518.b3ff0a","name":"Update Active to Handled","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"UPDATE `log` SET status = 'Manually Removed', statusTime = '{{timestamp}}' WHERE `index` = {{payload}};","output":"str","x":610,"y":300,"wires":[["81d2af9c.b2af1"]]},{"id":"81d2af9c.b2af1","type":"sqlite","z":"23c43518.b3ff0a","mydb":"fd38eee5.8bd8a","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":810,"y":300,"wires":[["28ec47d.cd906b8"]]},{"id":"28ec47d.cd906b8","type":"link out","z":"23c43518.b3ff0a","name":"","links":["13c2aaaa.74d295","f8b2c7bc.b77368","ed29f70d.9b66f8","f72ff61b.e8d618","9f5ece3e.bbcec"],"x":915,"y":300,"wires":[]},{"id":"bde9417c.ae3fa","type":"change","z":"23c43518.b3ff0a","name":"Time Now","rules":[{"t":"set","p":"timestamp","pt":"msg","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":420,"y":300,"wires":[["3dc80a3a.37f5b6"]]},{"id":"47f470.6d282b9","type":"http response","z":"23c43518.b3ff0a","name":"","statusCode":"","headers":{},"x":1130,"y":100,"wires":[]},{"id":"9b9c90b8.58988","type":"template","z":"23c43518.b3ff0a","name":"HTML","field":"payload","fieldType":"msg","format":"html","syntax":"mustache","template":"<!DOCTYPE html>\n<html>\n<head>\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    \n    <title>{{title}}</title>\n\n    <script>\n        {{{script}}}\n    </script>\n    \n    <style>\n        {{{global.css}}}\n    </style>\n\n</head>\n\n<body onload=\"startTime()\">\n    \n<audio id=\"beep\" src=\"data:audio/ogg;base64,{{payload}}\"></audio>\n\n\n<div class=\"heading\">\n          \n    <div class=\"left\">{{{global.left}}}</div>\n    \n    <div class=\"middle\">\n        <h1 id=\"title\">{{title}}</h1>\n    </div>\n    \n    <div class=\"right\">\n        <div class=\"clock\" id=\"time\"></div>\n    </div>\n    \n</div>\n\n<div class=\"wrapper\" id=\"data\">\n\n</div>\n\n\n\n</body>\n\n</html>","output":"str","x":1010,"y":100,"wires":[["47f470.6d282b9"]]},{"id":"5e777687.bf0378","type":"change","z":"23c43518.b3ff0a","name":"Title","rules":[{"t":"set","p":"title","pt":"msg","to":"CaptureCall Dynamic Display","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":270,"y":100,"wires":[["21e074bf.abeedc"]]},{"id":"d47e3460.18a298","type":"switch","z":"23c43518.b3ff0a","name":"","property":"payload","propertyType":"msg","rules":[{"t":"btwn","v":"0","vt":"num","v2":"9999","v2t":"num"}],"checkall":"true","repair":false,"outputs":1,"x":290,"y":300,"wires":[["bde9417c.ae3fa"]]},{"id":"1514a53b.f70ccb","type":"template","z":"23c43518.b3ff0a","name":"Script","field":"script","fieldType":"msg","format":"javascript","syntax":"plain","template":"var receive = new WebSocket('ws://' + location.host + '/display/receive');\nvar send = new WebSocket('ws://' + location.host + '/display/send');\nvar popup = new WebSocket('ws://' + location.host + '/display/alert');\n\n\nvar msg = 0; // Make Incoming WS Global\n\n// Change Main Data\nreceive.onmessage = function(d) {\n    var txt = d.data;\n    msg = JSON.parse(txt);\n    console.log(msg);\n    document.getElementById(\"data\").innerHTML = msg.payload;\n  \n};\n\n// Display Popup\npopup.onmessage = function(d) {\n    var txt = d.data;\n   alert(txt);\n};\n        \n// When the connection is open, send some data to the server\nsend.onopen = function() {\n    console.log('WebSocket Open');\n    send.send('Open');\n};\n\n//Play Sound\nsend.onmessage = function(d) {\nvar audio = document.getElementById(\"beep\"); \n  audio.play()\n};\n\nfunction startTime() { //Clock\n    var today = new Date();\n    var h = today.getHours();\n    var m = today.getMinutes();\n    var s = today.getSeconds();\n    m = checkTime(m);\n    s = checkTime(s);\n    document.getElementById('time').innerHTML = h + \":\" + m + \":\" + s;\n    var t = setTimeout(startTime, 500);\n} \n\nfunction checkTime(i) {\n    if (i < 10) {i = \"0\" + i}  // add zero in front of numbers < 10\n    return i;\n}\n\n\n\n// Make Sounds\nsound.onmessage = function() {\nconsole.log(\"sound\");\nvar audio = new Audio(\"data:audio/mp3;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAALAAANBwBAQEBAQEBAQEBSUlJSUlJSUlJiYmJiYmJiYmJycnJycnJycnKCgoKCgoKCgoKQkJCQkJCQkJCgoKCgoKCgoKCrq6urq6urq6u2tra2tra2trbk5OTk5OTk5OT///////////8AAABQTEFNRTMuOTlyBLkAAAAAAAAAADUgJAQvQQAB4AAADQdKxbtrAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//vAxAAADVwjWVTwACpfFWo/PQCAAAAIu/a28NWJuQtbNwGwAsAQBYELY1er1e/f3DAAAAFGw8Pf+AAI/44f/+AO8z/8Df/xwD/4Bj/8PAHfAAw/+h4AI8AAw8/MPAADwADDx+Y8AAPgIw9/zgAAAAAGHh4eHgAAAAAGHh4eHgAAAAChhQBQBQE4dEAYFA9BgGgXGAmLoYFAORjdzwNoYFYLRhYAbo3HEoKcSgXmJkAA+JgtgXGBWBcGA5SMwQQGHDD9QyyAvB28MijlC5gxSI5GJxWxDRzRzRWw5RJEB8hwzQuYmRzSZPF4yNvkVMi8TRiXUVskr+TJkXi8Yl0u/xEFQVER7/WCoiCoKiL/4VBURPOp6qJAwgAAAvqBwAAAYA4AdmAPAHZgTgFyYAgBPGAjgcRltqwSZH0KkmFcA3ZgpAHOYEmBeGBUgUhgXIEUYBmAVQNPtds3B1Ymh7T/p////////////o9z/vt1UpEAAACrmgBw1sAAGSacmRg8hpmc03qZwoaZg9AdHa+ZqJkGGTOW3imaRDE3IfyL2Or7//66AAAE9g4AAABgHoCIYCIAwmAwgTxgVgJ+YNCH5GWWPehlcIe0YL4CImrnxjhObCoHAV5qRWHBzqrWfm/Qyqlyp+3/lf/////////9P///////////b/6dU709nKbb/s+d0ZGN9stx2IAAACrgABwsQxxzIKOfEwegyjOxayM5gMowfQOTseMpAyTTGmLkQ/gmOzhy3/ilviv//qoAAAGsmBGAT5gTIGsYGYCpmCshRhhiw+qalX5VmoPD1JhaYRsaqUZl8sG3FWcZrBr0zAImpJMli16ORGm5O33/////////////9f//r////////9PVbvbPVWlQi9SiDPs7dx0qeUBHKdTi0QsQAAAJuQAHAFAaeBgDLJOiwwfwwTPEZtM60MMwgANjtfMtExjDHpLlw5muxy38fyL/+1DE4YBK8CsnvfSAINAFpv2fZEz2Ht//+3/////39FUAAAAEhUA4oQQMYjgxoVTJaONDSMwUsOaMkEcTjIxw4YwSoD9M1QDIBM1k6N0hzSB0WBn5ZNAt+PxKlezR/o//ps/9iN29/RX+n6P//9+ZT6a/pWlCSAAAAq5AAcDARahlhmUMdNZhABbGeuxIZ3wXBhBganc4ZSBinmJUXcjeCQ7DHLf+KW3M//+z///+hF3/////9f6lAAAE1gHAAABi4dmMyoZGSJn+UGCdB1Zk//tAxPkATNnlI6/sRyDPBab9n2RMTbmmZC8HMmCMggRqpJpRh3Gp9/xyzQsFdZksDWJiqeX3/7//////////9/9jNwwRz3+rpch5gGhQG4A0BmPBxpJyctGGLmO2c73WJzRjvmLsFMc+5miq5mycZnLmLkKxI2pg1t/Hci849v+3R///////o////9X//r1qAAADsfAFAABkUqGRjyZfZBqTHmDEicBlUUwQZSyJkGCuAsZmbcb/+0DE/AANgeEYj/BHCOyFZv2fZEx8HnCox01GbUTiQ82rJoFn5utjZod///1tHf/T/7v////uyaxixVTmFfe8XYKrHhKgygWEAAACbkABwABGgA4czAjtjMIYKIz+VijPeCkMIcC87nDKQMM8wLC6kbwXO7D/v/FLfFf//V///////////s1UVUIAYz7+4AAASFLnIghWQEDcyNmsyIDctkFIjQkcSzSsU71Xr3TlSrlbpAAAF//7QMT4gAqoKyXuf2JhBQVm/Z9kTNAAfKBMyoMNbOTtJAxtx5Tua77O1Me0xuAsDu4M1FnM6YjNbcxktVJDa5Hbfx/IvYe3//7f94//////////q8TgLWnvWlIAUy390AAAMEYwExCICITAMUjLLNDK0UAAAojkPFDjGgavZ7ivntn5XNY2aAAABfQQBEKmWhJrhkdvDmN4OMd4fBR28DmGN+FSd0/GnNBnLGZhcGKFip4YYG7E//swxP2CSdApJa5/QmEPhWU9v2xMNv/FLbmf//////1Yt///////9P9S6lEAMT38wAAAMizHgRBCujAQYzL/tzuGEwEKIAVWpPku0LAUJvqRc6KRCZrW6TAAAAVnj/1kAAw38N3MMrDjzB7wKswzgWeMaKMMDuOqDk6oNJTMnrHAzEyQYkwxkR3MQnDjTDYQz8wG0CxMBeAljAjA//tAxPeACygrIa5/YmD/hab9n2RMHQwX4DUMAcAHTABAFY0RTM0zQ0zlL8yNDkxANA1AY428bw18OQxHUk6Kqg5udY0OB4yZO80BNkIQsxqKwyuGIw7K81cXI1iSgzaIIwgC0x1KczFNczVMMybFMwGFwzDMcyrGswVCIxSF4xMCAwFEkx3Isx7D0wgHAzlO8x5F0w5A8UBIwkCwwuCYwiBYFAoz0wCABeoFAkwNAVdRgECBg0D/+yDE+wBFOCtLzHcCYR+FZPW/bEzhgsAAVA8w0DYwwCASBQLgGYEgSCgHZPVZWsIqRYjqOmieWnSvXgYBgKDgDfNcixJA+79uggHQfYPPNIUATEaY8aKiuIyzt+44zh1HTLkIoNpJWtrva/D9Ry5fEIYnX3Xe47wIB0w4HhhyH8ll//sgxPiAhaArR8z3AmEUBWTxv2xM7Cnjcbn6zsMMdSA0xF0SaVv/L7liVuQ7kOclbts7h+OOXD+UYpMZXTzDlu/L9Sh/IxOW4Yll+V1rkYnJt3IcpJ2Vxunv3/v2MN08rt2I3L5/CxhvDWXafK5hUs34pYpK9HNMSQwAsCoCkDgFgP/7oMT2AAWgK0XMd2Im17wivr/QBdxaGgwAAADSGKROAfMA4Aenjx9MM/zuNYgMs0wY3DqWzQacl/zEvI5MaQYo0FAeTHXGU/zewrOVnY3/oDYp9/zeiJNsQULsoKNAweLAcL//zWc9Mwmse+I9mjDwnMVFEwcFAIV///N6vIzY5zDTUBKONMkcCA9BRcYFBClf//+ZyFRmIjmSyoYKJ5hopmKBsMgJOZy3gdmg////MMhMHCIwwBzAoEMEhYVCJgQHQDEalD/zX////o0CQaFgSYEBYqCBCCVDxoCDQHrbua/HHV3/////9iTKWxPE77iO6159XBfTf/r9Zfr////////3LkT8w84UGvpSQfJn9gKC5LFN4/v/1r9f/7//////////+Lw9DMeiUbhyWw9GYZjkN/16mMWqTEFNRTMuOTkuM6qqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqv/7cMT/ACWls5n57n4AAAA0g4AABKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqo=\");\naudio.play();\n};\n","output":"str","x":890,"y":100,"wires":[["9b9c90b8.58988"]]},{"id":"21e074bf.abeedc","type":"file in","z":"23c43518.b3ff0a","name":"","filename":"/home/ingenso/.node-red/beepbeep.ogg","format":"","sendError":true,"x":500,"y":100,"wires":[["fd14aa2b.4f09c8"]]},{"id":"68624f2b.9b81f","type":"link in","z":"23c43518.b3ff0a","name":"Received Page","links":["c94a9d48.9c2c"],"x":35,"y":400,"wires":[["99982c5b.ae2dc"]]},{"id":"99982c5b.ae2dc","type":"websocket out","z":"23c43518.b3ff0a","name":"","server":"95962f80.19ef3","client":"","x":170,"y":400,"wires":[]},{"id":"8d8b9333.5f42e","type":"comment","z":"23c43518.b3ff0a","name":"Play Sound on Message","info":"","x":150,"y":360,"wires":[]},{"id":"73b19e8.a10406","type":"inject","z":"23c43518.b3ff0a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":160,"y":500,"wires":[["99982c5b.ae2dc"]]},{"id":"fd14aa2b.4f09c8","type":"base64","z":"23c43518.b3ff0a","name":"","action":"","property":"payload","x":760,"y":100,"wires":[["1514a53b.f70ccb"]]},{"id":"6166ccee.a7a074","type":"file in","z":"85d51a2d.db2228","name":"","filename":"/var/www/pager/received.txt","format":"utf8","chunk":false,"sendError":false,"x":280,"y":60,"wires":[["7135ce58.df4ed","db876576.365048"]]},{"id":"7135ce58.df4ed","type":"split","z":"85d51a2d.db2228","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":470,"y":60,"wires":[["b18c7c2.49bbc8"]]},{"id":"b18c7c2.49bbc8","type":"switch","z":"85d51a2d.db2228","name":"","property":"payload","propertyType":"msg","rules":[{"t":"cont","v":"Alpha","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":590,"y":60,"wires":[["ea4e9b5b.1385a8","a824ad1c.7ee63"]]},{"id":"db876576.365048","type":"change","z":"85d51a2d.db2228","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":500,"y":120,"wires":[["ec37a628.716678"]]},{"id":"ec37a628.716678","type":"file","z":"85d51a2d.db2228","name":"","filename":"/var/www/pager/received.txt","appendNewline":false,"createDir":false,"overwriteFile":"true","x":720,"y":120,"wires":[[]]},{"id":"6d186ac0.e7f904","type":"inject","z":"85d51a2d.db2228","name":"","topic":"","payload":"","payloadType":"str","repeat":"1","crontab":"","once":false,"onceDelay":0.1,"x":90,"y":60,"wires":[["6166ccee.a7a074"]]},{"id":"1c485e4b.a63e92","type":"subflow:76a9f5f0.1cf2dc","z":"e3cbac21.52804","name":"","x":170,"y":140,"wires":[["c94a9d48.9c2c","bb983eee.bde5b"]]},{"id":"ea0ecadf.2504f8","type":"comment","z":"e3cbac21.52804","name":"Receive Page","info":"","x":150,"y":60,"wires":[]},{"id":"4c566771.e36038","type":"template","z":"e3cbac21.52804","name":"Add Msg to DB","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO `log` ('capcode', 'pagerNumber', 'sysID', 'group', 'content', 'msgPart1', 'msgPart2', 'sender', 'rxTime', 'status', 'statusTime', 'FP', 'payload') VALUES ('{{capcode}}', '{{pagerNumber}}', '{{sysID}}', '{{{group}}}', '{{content}}', '{{msgPart1}}', '{{msgPart2}}', '{{sender}}','{{timestamp}}', '{{Status}}', '{{timestamp}}', '{{{FP}}}', '{{payload}}');","output":"str","x":220,"y":320,"wires":[["76901721.920c58"]]},{"id":"c7eb5365.d6ebd","type":"link in","z":"e3cbac21.52804","name":"Received Page","links":["c94a9d48.9c2c"],"x":95,"y":320,"wires":[["4c566771.e36038"]]},{"id":"76901721.920c58","type":"sqlite","z":"e3cbac21.52804","mydb":"fd38eee5.8bd8a","sqlquery":"msg.topic","sql":"","name":"CaptureCall","x":390,"y":320,"wires":[["bd94c0cf.ee355"]]},{"id":"bd94c0cf.ee355","type":"switch","z":"e3cbac21.52804","name":"","property":"Status","propertyType":"msg","rules":[{"t":"eq","v":"Attended","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":530,"y":320,"wires":[["61c3188a.69cf28"],["5652483b.e30f08"]]},{"id":"acf8374d.224558","type":"serial in","z":"76a9f5f0.1cf2dc","name":"","serial":"aae6ab09.c69b28","x":110,"y":120,"wires":[["c225fa15.f34b38","b5533914.8b1f58"]]},{"id":"6862b344.2783ac","type":"function","z":"76a9f5f0.1cf2dc","name":"LRS Process Page","func":"//Input\nvar payload = msg.payload;\nvar shortened = payload.slice(8,payload.length -2) //Remove Serial Data from front of Message\nvar duplicate = msg.duplicate;\n//Get Capcode and Message\nvar capcode = shortened.substring(1,8);\nvar message = shortened.substring(9,payload.length);\n\n//Calculate Pager number and SysID\nvar cc = capcode.toString();\nvar pagerStr = cc.substring(cc.length - 5, cc.Length);\nvar pagercalc = parseInt(pagerStr);\nvar pagerNumber = pagercalc/8;\nvar sysID = ((capcode - pagercalc)-700000)/100000;\n\n//Check If Group Message\nif (message.includes(\"[\")) {\n    var group = message.substring(1,3);\n    var msgStart = message.indexOf(\"]\") + 1;\n} else { \n    var group = \"n/a\";\n    var msgStart = 0;\n}\n\n//Check If Contains Flash Pattern and Get Sender ID\nif (message.includes(\"%\")) {\n    var percentIndex = message.indexOf(\"%\"); //Find Index of %\n    var FP = message.substring(percentIndex + 3,message.length);\n    var sender = message.substring(percentIndex - 2, percentIndex);\n    var msgEnd = percentIndex -3;\n} else { \n    var FP = \"n/a\";\n    var sender = message.substring(message.length - 2, message.length);\n    var msgEnd = message.length - 2;\n}\n\n//Get Total Message\nvar content = message.substring(msgStart,msgEnd);\n\n//Split Message into Part 1 and Part 2\nvar Part = content.split(\"-\");\n\nvar msgPart1 = Part[0];\nvar msgPart2 = Part[1];\n\n//Set Status Message\n\nif (message.includes(\"Handled\")) {\n   var status = \"Attended\";\n} else if (message.includes(\"Late\")) {\n    var status = \"Late\";\n} else if (duplicate === true) {\n    var status = \"Duplicate\";\n}else {\n    var status = \"Active\";\n}\n\n//Outputs\nmsg.capcode = capcode;  //Capcode\nmsg.pagerNumber = pagerNumber; //Pager Number\nmsg.sysID = sysID; //System ID\nmsg.group = group; //Group Number\nmsg.content = content; //Whole Message\nmsg.msgPart1 = msgPart1 //Part One of Message\nmsg.msgPart2 = msgPart2 //Part Two of Message\nmsg.sender = sender; //Originating Button or Table\nmsg.timestamp = Date.now(); //Current Timestamp\nmsg.Status = status; //Status\nmsg.FP = FP; //Flash Pattern\nmsg.payload = payload;\nreturn msg;","outputs":1,"noerr":0,"x":1010,"y":100,"wires":[[]]},{"id":"362ce8e2.692a68","type":"comment","z":"76a9f5f0.1cf2dc","name":"Receive Page LRS","info":"","x":130,"y":80,"wires":[]},{"id":"c225fa15.f34b38","type":"switch","z":"76a9f5f0.1cf2dc","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"","vt":"prev"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":650,"y":120,"wires":[["36078a36.43f4d6"],["27bb61c3.cc600e"]]},{"id":"27bb61c3.cc600e","type":"switch","z":"76a9f5f0.1cf2dc","name":"","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"Reset","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":810,"y":140,"wires":[["6862b344.2783ac"],[]]},{"id":"590a7a2d.90e434","type":"delay","z":"76a9f5f0.1cf2dc","name":"","pauseType":"delay","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":440,"y":160,"wires":[["badbbd1e.54555"]]},{"id":"badbbd1e.54555","type":"change","z":"76a9f5f0.1cf2dc","name":"Reset","rules":[{"t":"set","p":"payload","pt":"msg","to":"Reset","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":570,"y":160,"wires":[["c225fa15.f34b38"]]},{"id":"36078a36.43f4d6","type":"change","z":"76a9f5f0.1cf2dc","name":"","rules":[{"t":"set","p":"duplicate","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":810,"y":100,"wires":[["6862b344.2783ac"]]},{"id":"b5533914.8b1f58","type":"delay","z":"76a9f5f0.1cf2dc","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"3","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"x":280,"y":160,"wires":[["590a7a2d.90e434"]]},{"id":"4437d3de.ca8fdc","type":"function","z":"85d51a2d.db2228","name":"SDR Process Page","func":"//Input\nvar payload = msg.payload;\nvar shortened = payload.slice(22,payload.length -2) //Remove Serial Data from front of Message\nvar duplicate = msg.duplicate;\n\n//Get Capcode and Message\nvar capcode = shortened.substring(1,8);\nvar message = shortened.substring(27,payload.length);\n\n//Calculate Pager number and SysID\nvar cc = capcode.toString();\nvar pagerStr = cc.substring(cc.length - 5, cc.Length);\nvar pagercalc = parseInt(pagerStr);\nvar pagerNumber = pagercalc/8;\nvar sysID = ((capcode - pagercalc)-700000)/100000;\n\n//Check If Group Message\nif (message.includes(\"[\")) {\n    var group = message.substring(1,3);\n    var msgStart = message.indexOf(\"]\") + 1;\n} else { \n    var group = \"NULL\";\n    var msgStart = 0;\n}\n\n//Check If Contains Flash Pattern and Get Sender ID\nif (message.includes(\"%\")) {\n    var percentIndex = message.indexOf(\"%\"); //Find Index of %\n    var FP = message.substring(percentIndex,message.length);\n    var sender = message.substring(percentIndex - 2, percentIndex);\n    var msgEnd = percentIndex -3;\n} else { \n    var FP = \"NULL\";\n    var sender = message.substring(message.length - 2, message.length);\n    var msgEnd = message.length - 2;\n}\n\n//Get Total Message\nvar content = message.substring(msgStart,msgEnd);\n\n//Split Message into Part 1 and Part 2\nvar Part = content.split(\"-\");\n\nvar msgPart1 = Part[0];\nvar msgPart2 = Part[1];\n\n//Set Status Message\n\nif (message.includes(\"Handled\")) {\n   var status = \"Attended\";\n} else if (message.includes(\"Late\")) {\n    var status = \"Late\";\n} else if (duplicate === true) {\n    var status = \"Duplicate\";\n}else {\n    var status = \"Active\";\n}\n\n//Outputs\nmsg.capcode = capcode;  //Capcode\nmsg.pagerNumber = pagerNumber; //Pager Number\nmsg.sysID = sysID; //System ID\nmsg.group = group; //Group Number\nmsg.content = content; //Whole Message\nmsg.msgPart1 = msgPart1 //Part One of Message\nmsg.msgPart2 = msgPart2 //Part Two of Message\nmsg.sender = sender; //Originating Button or Table\nmsg.timestamp = Date.now(); //Current Timestamp\nmsg.Status = status; //Status\nmsg.FP = FP; //Flash Pattern\nmsg.payload = payload;\nreturn msg;","outputs":1,"noerr":0,"x":1590,"y":60,"wires":[["c069402f.1648"]]},{"id":"a824ad1c.7ee63","type":"switch","z":"85d51a2d.db2228","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"","vt":"prev"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1190,"y":60,"wires":[["d3ace321.da0a2"],["86f322ba.5684b"]]},{"id":"86f322ba.5684b","type":"switch","z":"85d51a2d.db2228","name":"","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"Reset","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1330,"y":80,"wires":[["4437d3de.ca8fdc"],[]]},{"id":"d4ae2e26.c386","type":"delay","z":"85d51a2d.db2228","name":"","pauseType":"delay","timeout":"10","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":920,"y":80,"wires":[["b87018e8.c974d8"]]},{"id":"b87018e8.c974d8","type":"change","z":"85d51a2d.db2228","name":"Reset","rules":[{"t":"set","p":"payload","pt":"msg","to":"Reset","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1050,"y":80,"wires":[["a824ad1c.7ee63"]]},{"id":"d3ace321.da0a2","type":"change","z":"85d51a2d.db2228","name":"","rules":[{"t":"set","p":"duplicate","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":1370,"y":40,"wires":[["4437d3de.ca8fdc"]]},{"id":"ea4e9b5b.1385a8","type":"delay","z":"85d51a2d.db2228","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"10","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"x":760,"y":80,"wires":[["d4ae2e26.c386"]]},{"id":"c069402f.1648","type":"debug","z":"85d51a2d.db2228","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1770,"y":120,"wires":[]},{"id":"aab2c1e6.9a895","type":"comment","z":"36884d4.675edb2","name":"Receive Page SDR","info":"","x":130,"y":140,"wires":[]},{"id":"c4b0932f.dcca6","type":"file in","z":"36884d4.675edb2","name":"","filename":"/var/www/pager/received.txt","format":"utf8","chunk":false,"sendError":false,"x":280,"y":180,"wires":[["7f2b7034.08f32","f1d91b6b.87dcb8"]]},{"id":"7f2b7034.08f32","type":"split","z":"36884d4.675edb2","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":470,"y":180,"wires":[["223ab33c.17fa7c"]]},{"id":"223ab33c.17fa7c","type":"switch","z":"36884d4.675edb2","name":"","property":"payload","propertyType":"msg","rules":[{"t":"cont","v":"Alpha","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":590,"y":180,"wires":[["f14bfef2.a9f55","2cfd18cf.c216a8"]]},{"id":"f1d91b6b.87dcb8","type":"change","z":"36884d4.675edb2","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":500,"y":240,"wires":[["2f5598c2.2c24d8"]]},{"id":"2f5598c2.2c24d8","type":"file","z":"36884d4.675edb2","name":"","filename":"/var/www/pager/received.txt","appendNewline":false,"createDir":false,"overwriteFile":"true","x":720,"y":240,"wires":[[]]},{"id":"17dad8c4.baefe7","type":"inject","z":"36884d4.675edb2","name":"","topic":"","payload":"","payloadType":"str","repeat":"1","crontab":"","once":false,"onceDelay":0.1,"x":90,"y":180,"wires":[["c4b0932f.dcca6"]]},{"id":"ab560e90.c8863","type":"function","z":"36884d4.675edb2","name":"SDR Process Page","func":"//Input\nvar payload = msg.payload;\nvar shortened = payload.slice(21,payload.length - 4) //Remove Serial Data from front of Message\nvar duplicate = msg.duplicate;\n\n//Get Capcode and Message\nvar capcode = shortened.substring(1,7);\nvar message = shortened.substring(27,payload.length);\n\n//Calculate Pager number and SysID\nvar cc = \"0\" + capcode.toString();\nvar pagerStr = cc.substring(cc.length - 5, cc.Length);\nvar pagercalc = parseInt(pagerStr);\nvar pagerNumber = pagercalc/8;\nvar sysID = ((capcode - pagercalc)-700000)/100000;\n\n//Check If Group Message\nif (message.includes(\"\")) {\n    var group = message.substring(6,7);\n    var msgStart = message.indexOf(\"\") + 1;\n} else { \n    var group = \"NULL\";\n    var msgStart = 4;\n}\n\n//Check If Contains Flash Pattern and Get Sender ID\nif (message.includes(\"%\")) {\n    var percentIndex = message.indexOf(\"%\"); //Find Index of %\n    var FP = message.substring(percentIndex,message.length);\n    var sender = message.substring(percentIndex - 2, percentIndex);\n    var msgEnd = percentIndex -0;\n} else { \n    var FP = \"NULL\";\n    var sender = message.substring(message.length - 3, message.length - 1);\n    var msgEnd = message.length - 4;\n}\n\n//Get Total Message\nvar content = message.substring(msgStart,msgEnd);\n\n//Split Message into Part 1 and Part 2\nvar Part = content.split(\"-\");\n\nvar msgPart1 = Part[0];\nvar msgPart2 = Part[1];\n\n//Set Status Message\n\nif (message.includes(\"Handled\")) {\n   var status = \"Attended\";\n} else if (message.includes(\"Late\")) {\n    var status = \"Late\";\n} else if (duplicate === true) {\n    var status = \"Duplicate\";\n}else {\n    var status = \"Active\";\n}\n\n//Outputs\nmsg.capcode = capcode;  //Capcode\nmsg.pagerNumber = pagerNumber; //Pager Number\nmsg.sysID = sysID; //System ID\nmsg.group = group; //Group Number\nmsg.content = content; //Whole Message\nmsg.msgPart1 = msgPart1 //Part One of Message\nmsg.msgPart2 = msgPart2 //Part Two of Message\nmsg.sender = sender; //Originating Button or Table\nmsg.timestamp = Date.now(); //Current Timestamp\nmsg.Status = status; //Status\nmsg.FP = FP; //Flash Pattern\nmsg.payload = payload;\nreturn msg;","outputs":1,"noerr":0,"x":1590,"y":180,"wires":[["25c8e80a.da39b8"]]},{"id":"2cfd18cf.c216a8","type":"switch","z":"36884d4.675edb2","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"","vt":"prev"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1190,"y":180,"wires":[["e8006be8.f4f268"],["90ca7da0.c3c54"]]},{"id":"90ca7da0.c3c54","type":"switch","z":"36884d4.675edb2","name":"","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"Reset","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1330,"y":200,"wires":[["ab560e90.c8863"],[]]},{"id":"8bee0926.b0c1e8","type":"delay","z":"36884d4.675edb2","name":"","pauseType":"delay","timeout":"10","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":920,"y":200,"wires":[["7b7c52f9.55555c"]]},{"id":"7b7c52f9.55555c","type":"change","z":"36884d4.675edb2","name":"Reset","rules":[{"t":"set","p":"payload","pt":"msg","to":"Reset","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1050,"y":200,"wires":[["2cfd18cf.c216a8"]]},{"id":"e8006be8.f4f268","type":"change","z":"36884d4.675edb2","name":"","rules":[{"t":"set","p":"duplicate","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":1370,"y":160,"wires":[["ab560e90.c8863"]]},{"id":"f14bfef2.a9f55","type":"delay","z":"36884d4.675edb2","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"10","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"x":760,"y":200,"wires":[["8bee0926.b0c1e8"]]},{"id":"25c8e80a.da39b8","type":"debug","z":"36884d4.675edb2","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1770,"y":180,"wires":[]},{"id":"16a49dc6.39c7b2","type":"function","z":"23c43518.b3ff0a","name":"Set Style","func":"var array = msg.payload\nvar i;\nfor (i = 0; i < array.length; i++) { \n    \n  if (msg.payload[i].FP != \"n/a\") {\n    msg.payload[i].style = msg.payload[i].FP\n} else {\n    msg.payload[i].style = \"\"\n}\n}\nreturn msg;","outputs":1,"noerr":0,"x":620,"y":200,"wires":[["5ea79923.89c6a8"]]},{"id":"5065be0a.03bf6","type":"function","z":"1c96dbb1.1bc354","name":"Set Style","func":"var array = msg.payload\nvar i;\nfor (i = 0; i < array.length; i++) { \n    \n  if (msg.payload[i].FP != \"n/a\") {\n    msg.payload[i].style = msg.payload[i].FP\n} else {\n    msg.payload[i].style = \"\"\n}\n}\nreturn msg;","outputs":1,"noerr":0,"x":540,"y":260,"wires":[["575acb3d.97bd64"]]},{"id":"6e2bd65b.184aa8","type":"switch","z":"ad17a71d.1e1ea8","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"","vt":"prev"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":750,"y":140,"wires":[[],["7de0b76.864a648"]]},{"id":"7de0b76.864a648","type":"switch","z":"ad17a71d.1e1ea8","name":"","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"Reset","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":890,"y":160,"wires":[["e437ebab.d8f228"],[]]},{"id":"c7b1bcac.3e408","type":"delay","z":"ad17a71d.1e1ea8","name":"","pauseType":"delay","timeout":"6","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":480,"y":160,"wires":[["7918c3a8.093bbc"]]},{"id":"7918c3a8.093bbc","type":"change","z":"ad17a71d.1e1ea8","name":"Reset","rules":[{"t":"set","p":"payload","pt":"msg","to":"Reset","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":610,"y":160,"wires":[["6e2bd65b.184aa8"]]},{"id":"a0ea9e5a.b4884","type":"delay","z":"ad17a71d.1e1ea8","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"5","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"x":320,"y":160,"wires":[["c7b1bcac.3e408"]]},{"id":"56d4f7ac.f63038","type":"serial in","z":"ad17a71d.1e1ea8","name":"","serial":"aae6ab09.c69b28","x":70,"y":140,"wires":[["a0ea9e5a.b4884","ccc9c4ef.3765d8","70570229.0bb68c"]]},{"id":"714707a6.94e268","type":"template","z":"ad17a71d.1e1ea8","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"CCPAGE,{{capcode}},Repeated {{message}}","output":"str","x":1160,"y":160,"wires":[["b9411228.18053","2a05777d.7512d8"]]},{"id":"b9411228.18053","type":"serial out","z":"ad17a71d.1e1ea8","name":"","serial":"97f51a17.2797b8","x":1320,"y":160,"wires":[]},{"id":"4976851.346467c","type":"comment","z":"ad17a71d.1e1ea8","name":"Smart Page","info":"","x":150,"y":60,"wires":[]},{"id":"e437ebab.d8f228","type":"function","z":"ad17a71d.1e1ea8","name":"","func":"//Input\nvar payload = msg.payload;\nvar shortened = payload.slice(8,payload.length -2) //Remove Serial Data from front of Message\nmsg.capcode = shortened.substring(1,8);\nmsg.message = shortened.substring(9,payload.length);\nreturn msg;","outputs":1,"noerr":0,"x":1030,"y":160,"wires":[["714707a6.94e268"]]},{"id":"2a05777d.7512d8","type":"debug","z":"ad17a71d.1e1ea8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1320,"y":240,"wires":[]},{"id":"ced8cec4.222e6","type":"inject","z":"ad17a71d.1e1ea8","name":"","topic":"","payload":"RPTRX,0","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1160,"y":60,"wires":[["b9411228.18053"]]},{"id":"ccc9c4ef.3765d8","type":"debug","z":"ad17a71d.1e1ea8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":310,"y":100,"wires":[]},{"id":"70570229.0bb68c","type":"delay","z":"ad17a71d.1e1ea8","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":480,"y":120,"wires":[["6e2bd65b.184aa8"]]}]